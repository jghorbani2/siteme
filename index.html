<!-- Sanitized for GitHub Pages: removed external map scripts and API keys; logos stripped. -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Javad Ghorbani — Portfolio</title>
  <meta name="description" content="Portfolio of Javad Ghorbani — interactive systems, geotechnical intelligence, autonomous modelling, and scientific visualization." />
  <meta property="og:title" content="Javad Ghorbani — Portfolio" />
  <meta property="og:description" content="Interactive projects spanning geotechnical intelligence, autonomous modelling, and scientific visualization." />
  <meta property="og:type" content="website" />
  <!-- TODO: Replace with absolute URLs in production -->
  <meta property="og:image" content="assets/social/spider-card.png" />
  <meta property="og:url" content="/" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="theme-color" content="#0b0b0b" />
  <link rel="preload" href="assets/style.css" as="style" />
  <link rel="stylesheet" href="assets/style.css" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-72C3D42HM0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} // eslint-disable-line
    gtag('js', new Date());
    gtag('config', 'G-72C3D42HM0');
  </script>

  <style>
    /* Hide legacy research sections for portfolio conversion */
    #gencai-multiagent, #focus, #practical, #publications, #repositories, #team, #page2, #architecture-canvas, #system-animation, #ground-assessment, #alpha-calibration { display:none !important; }

    /* Projects grid */
    #projects .cards{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; }
    #projects .card{ display:flex; flex-direction:column; gap:.6rem }
    #projects .card h3{ margin:.2rem 0 0 }
    #projects .card p{ margin:0; color:var(--muted) }
    @media (max-width: 900px){ #projects .cards{ grid-template-columns:1fr 1fr } }
    @media (max-width: 560px){ #projects .cards{ grid-template-columns:1fr } }
    /* ========== Overlay that hosts deep-dive animations ========== */
    .deep-overlay{ position:fixed; inset:0; z-index:9999; display:none; }
    .deep-overlay.active{ display:block; }
    .deep-overlay .scrim{ position:absolute; inset:0; background:rgba(6,10,18,0.72); backdrop-filter:blur(4px) saturate(1.05); }
    .deep-overlay .frame{ position:absolute; inset:0; }
    .deep-overlay iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; background:transparent; }
    .deep-overlay .close{ position:absolute; right:16px; top:16px; z-index:2; border:1px solid var(--stroke); background:rgba(20,17,17,.9); color:var(--fg); border-radius:10px; padding:8px 12px; cursor:pointer; font:700 13px/1 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .deep-overlay .meta-links{ position:absolute; left:16px; top:16px; z-index:2; display:flex; gap:8px; }
    .deep-overlay .meta-links a{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:rgba(26,20,17,.85); color:var(--fg); font:700 12px/1 system-ui; text-decoration:none }

    /* ========== Section-specific sizing for iframes on the page ========== */
    #architecture-canvas.section--animation { padding:0; height:100svh; }
    @supports (height: 100dvh) {
      #architecture-canvas.section--animation { height:100dvh; }
    }
    #architecture-canvas iframe { width:100%; height:100%; border:0; display:block; }

    .section--animation { padding:0; height:100svh; }
    @supports (height: 100dvh) {
      .section--animation { height:100dvh; }
    }

    .iframe-wrap { position:relative; height:100%; }
    .iframe-wrap iframe { position:relative; z-index:1; width:100%; height:100%; border:0; display:block; pointer-events:none; }
    .iframe-veil { position:absolute; inset:0; z-index:2; display:flex; align-items:center; justify-content:center; padding:0; border:0; cursor:pointer; background:linear-gradient(180deg, rgba(11,11,11,.55), rgba(11,11,11,.35)); color:var(--fg); text-align:center; }
    .iframe-veil .veil-inner { backdrop-filter: blur(4px); padding:14px 18px; border-radius:12px; background:rgba(16,22,36,.55); border:1px solid rgba(60,84,126,.45); font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .iframe-veil strong { display:block; font-size:16px; line-height:1.25; }
    .iframe-veil span { display:block; font-size:13px; opacity:.9; margin-top:4px; }
    .iframe-veil small { display:block; font-size:11px; opacity:.75; margin-top:6px; }

    .exit-btn { position:absolute; z-index: 9999; top:12px; right:12px; background:rgba(20,17,17,.85); color:var(--fg); border:1px solid var(--stroke); border-radius:8px; padding:6px 10px; font:600 12px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; cursor:pointer; opacity:0; pointer-events:none; transition:opacity .18s ease; }
    .iframe-wrap.active iframe { pointer-events:auto; }
    .iframe-wrap.active .iframe-veil { opacity:0; visibility:hidden; pointer-events:none; transition:opacity .18s ease; }
    .iframe-wrap.active .exit-btn { opacity:1; pointer-events:auto; }

    /* ========== NEW PAGE 1.5: Core Research Focus (INSERTED AFTER HERO) ========== */
    .page-focus{
      position: relative;
      background: radial-gradient(1200px 800px at 50% 12%, #1a1613 0%, #0b0b0b 58%, #141111 100%);
      color:var(--fg);
      padding:52px 0 36px;
      border-top:1px solid var(--stroke);
      border-bottom:1px solid var(--stroke);
      overflow:hidden;
    }
    .page-focus:before{
      /* soft decorative mesh */
      content:""; position:absolute; inset:-10% -10% auto -10%; height:260px; z-index:0;
      background: radial-gradient(40% 60% at 70% 40%, rgba(212,175,55,.14), transparent 60%),
                  radial-gradient(40% 60% at 30% 60%, rgba(122,31,31,.10), transparent 60%);
      filter: blur(30px);
    }
    .page-focus .container{ max-width:1100px; margin:0 auto; padding:0 16px; position:relative; z-index:1; }

    .focus-head{ display:grid; place-content:center; text-align:center; gap:10px; margin:0 0 18px; }
    .focus-head h2{ margin:0; letter-spacing:.3px; font:800 clamp(24px,3vw,34px)/1.2 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .focus-head p{ margin:0 auto; max-width:68ch; color:var(--muted); opacity:.95; text-wrap:balance; }

    .pillrow--center{ justify-content:center; margin-top:14px; }

    .focus-grid{ display:grid; grid-template-columns: repeat(4, minmax(240px, 1fr)); gap:14px; margin:18px 0 4px; }
    .pillar-card{
      position:relative; display:flex; flex-direction:column; gap:10px; padding:16px; border-radius:16px; text-align:left;
      border:1px solid transparent;
      background: linear-gradient( rgba(26,20,17,.78), rgba(20,16,14,.74) ) padding-box,
                  linear-gradient(135deg, rgba(212,175,55,.5), rgba(122,31,31,.35)) border-box;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      backdrop-filter: blur(6px) saturate(1.03);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .pillar-card:hover{ transform: translateY(-3px); box-shadow:0 18px 44px rgba(0,0,0,.45); }
    .pillar-card h3{ margin:0; font:800 16px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .pillar-card p{ margin:0; font-size:14px; color:var(--muted); }
    .pillar-meta{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .tag{ display:inline-flex; align-items:center; gap:6px; padding:5px 8px; border-radius:999px; border:1px solid var(--stroke); background:rgba(26,20,17,.65); font:700 11px/1 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color:var(--fg); }

    .pillar-list{ margin:10px 0 0; padding-left:18px; color:#cfe3ff; font-size:13px; }

    .focus-cta{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:16px; }

    /* Interactive Pillars Styles */
    .pillars-interactive{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; margin:24px 0; }

    .pillar-item{ border-radius:12px; overflow:hidden; background: linear-gradient(135deg, rgba(16,24,40,.8), rgba(20,30,50,.6)); border:1px solid rgba(60,84,126,.3); backdrop-filter: blur(8px); }

    .pillar-toggle{
      width:100%; display:flex; align-items:center; justify-content:space-between; padding:16px 20px;
      background: linear-gradient(135deg, rgba(212,175,55,.10), rgba(122,31,31,.08));
      border:none; color:var(--fg); cursor:pointer; transition: all 0.3s ease;
      text-align:left;
    }
    .pillar-toggle:hover{ background: linear-gradient(135deg, rgba(212,175,55,.16), rgba(122,31,31,.12)); }
    .pillar-toggle:focus{ outline:2px solid var(--brand); outline-offset:2px; }

    .pillar-toggle h3{ margin:0; font:700 18px/1.3 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .toggle-icon{ font-size:14px; font-weight:bold; color:var(--brand); transition: transform 0.3s ease; }

    .pillar-toggle[aria-expanded="true"] .toggle-icon{ transform: rotate(90deg); }

    .pillar-content{
      padding:20px; border-top:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(20,16,14,.4), rgba(18,14,12,.3));
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .pillar-content.expanded{
      max-height: 300px;
      animation: slideDown 0.3s ease-out;
    }

    .pillar-content p{ margin:0 0 16px; font-size:15px; line-height:1.5; color:var(--muted); }
    .pillar-content strong{ color:var(--brand); }

    .pillar-highlights{ display:flex; flex-wrap:wrap; gap:8px; }
    .highlight{
      padding:6px 12px; border-radius:20px; font-size:12px; font-weight:600;
      background: linear-gradient(135deg, rgba(212,175,55,.18), rgba(122,31,31,.12));
      border:1px solid rgba(212,175,55,.35); color:#d4af37;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive behavior */
    @media (max-width: 1200px) {
      .pillars-interactive{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .pillars-interactive{ grid-template-columns: 1fr; }
      .pillar-toggle h3{ font-size:16px; }
    }

    /* compact CTA row for deep-dive */
    .deep-cta{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px; }

    /* ========== PAGE 2: formal header + intro story (CLEANED) ========== */
    .page2 {
      background: radial-gradient(1200px 800px at 50% 18%, #0e1628 0%, #0b0f1a 58%, #090e18 100%);
      color:#e5edff;
      padding:28px 0 16px; /* ↓ less vertical padding */
      border-top:1px solid rgba(60,84,126,.25);
      border-bottom:1px solid rgba(60,84,126,.2);
    }
    .page2 .container { max-width:1100px; margin:0 auto; padding:0 16px; }

    /* Formal, centered title + description */
    .page2 .section-head{
      min-height: clamp(160px, 32vh, 360px); /* ↓ not so tall */
      display: grid;
      place-content: center;
      justify-items: center;
      text-align: center;
      gap: 12px;
      margin: 0;
      padding: 10px 0; /* add a bit of internal spacing */
    }
    .page2 .section-head .title{
      margin: 0;
      font: 800 clamp(24px, 3.2vw, 36px)/1.15 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      letter-spacing: .3px;
    }
    .page2 .section-head .desc{
      max-width: 72ch;
      margin-inline: auto;
      color: #d8e6ff;
      opacity: .95;
      text-wrap: balance;
    }

    /* Pills */
    .pillrow { display:flex; flex-wrap:wrap; gap:8px; margin:16px 0 0; list-style:none; padding:0; justify-content:center; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #2a3b5d; background:rgba(17,26,44,.65); font:700 12px/1 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color:#d9e7ff; }

    /* Story cards */
    .story { display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap:14px; margin:18px 0 6px; justify-items:center; }
    .story .card.pro{
      position:relative; border:1px solid transparent;
      background: linear-gradient( rgba(16,24,40,.78), rgba(16,24,40,.74) ) padding-box,
                  linear-gradient(135deg, rgba(97,169,255,.55), rgba(142,245,192,.45)) border-box;
      border-radius:16px; padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      backdrop-filter: blur(6px) saturate(1.03);
      transition: transform .18s ease, box-shadow .18s ease;
      text-align:center;
    }
    .story .card.pro:hover{ transform:translateY(-3px); box-shadow:0 18px 44px rgba(0,0,0,.45); }
    .story .card.pro h3{ margin:0 0 8px; font:800 16px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .story .card.pro p{ margin:0; font-size:14px; color:#d7e5ff; }
    .story .card.pro ul{ text-align:left; margin:10px auto 0; max-width:36ch; color:#cfe3ff; font-size:13px; }

    /* Outcomes */
    .outcomes{ display:grid; grid-template-columns: repeat(4,1fr); gap:12px; margin:14px 0 0; justify-items:center; }
    .outcomes .ok{
      text-align:center; padding:10px; border-radius:12px;
      border:1px solid transparent;
      background: linear-gradient( rgba(18,28,48,.7), rgba(18,28,48,.7) ) padding-box,
                  linear-gradient(135deg, rgba(97,169,255,.55), rgba(142,245,192,.45)) border-box;
      box-shadow:0 8px 22px rgba(0,0,0,.35);
    }
    .outcomes .ok strong{ display:block; font:800 13px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin-bottom:2px; }
    .outcomes .ok span{ color:#a9b8d6; font-size:12px; }

    /* Center the secondary section lede + title */
    #system-animation h2 { text-align: center; }
    #system-animation .lede { margin: 0 auto; text-align: center; }

    /* Skip link visibility */
    .skip{ position:absolute; left:-9999px; top:auto; }
    .skip:focus{ left:16px; top:16px; background:#0d1424; color:#cfe3ff; padding:.5rem .75rem; border-radius:.5rem; z-index:10000; outline:2px solid #5fa8ff; }

    /* Simple utilities for new sections */
    .repo-list, .pub-list, .people { display:grid; gap:12px; }
    .repo-list { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .pub-list  { grid-template-columns: 1fr; }
    .people    { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .card .meta { font-size:12px; color:#a9b8d6; margin-top:6px; }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    /* ===== Practical Application (Map Demo) ===== */
    #practical .grid{ display:grid; grid-template-columns: 1.4fr 1fr; gap:14px; }
    #practical #map{ height: 420px; border-radius: 14px; overflow:hidden; border:1px solid #27324a; box-shadow: var(--shadow); }
    #practical .panel{ background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:14px; box-shadow: var(--shadow); }
    #practical .panel .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    #practical label{ display:grid; gap:6px; font-size:13px; color:#a9b8d6; }
    #practical input, #practical select{ background:#0e1526; border:1px solid var(--stroke); border-radius:10px; padding:.55rem .7rem; color:var(--fg); }
    #practical .small{ font-size:12px; color:#a9b8d6; }
    #practical .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    #practical .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #2a3b5d; background:rgba(17,26,44,.65); font:700 11px/1 system-ui; color:#d9e7ff; }
    #practical .chip[data-state="done"]{ border-color:#2a5d3b; background:rgba(17,44,26,.65); color:#bdf3c9; }
    #practical .results{ margin-top:10px; padding:10px; border:1px solid var(--stroke); border-radius:12px; background:rgba(19,27,45,.5); }
    #practical pre{ margin:8px 0 0; max-height:180px; overflow:auto; background:#0e1526; border:1px solid var(--stroke); border-radius:10px; padding:10px; color:#cfe3ff; font-size:12px; }
    @media (max-width: 900px){ #practical .grid{ grid-template-columns: 1fr; } #practical #map{ height: 360px; } }

    /* Charts */
    #practical .charts{ margin-top:14px; }
    #practical .charts-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    #practical .chart-card{ background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:10px; box-shadow: var(--shadow); }
    #practical .chart-box{ position:relative; height:220px; }
    #practical .chart-box canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; }
    @media (max-width: 1120px){ #practical .charts-grid{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 720px){ #practical .charts-grid{ grid-template-columns: 1fr; } }

    /* Responsive tweaks */
    @media (max-width: 1120px){
      .focus-grid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    @media (max-width: 960px){
      .story{ grid-template-columns:1fr; }
      .outcomes{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width: 640px){
      .page2 .section-head{ min-height:44vh; gap:10px; }
      .focus-grid{ grid-template-columns: 1fr; }
    }

    /* ==== Research Team: centered, visual cards + modal bios ==== */
    #team .team-head{ text-align:center; margin:0 0 12px; }
    #team .team-head .lede{ margin:6px auto 0; max-width:60ch; color:#d8e6ff; opacity:.95; }

    #team .people{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 280px));
      justify-content:center;
      gap:16px;
    }

    /* Card */
    #team .card.person{
      position:relative; display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px;
      padding:16px; border-radius:16px; cursor:default;
      border:1px solid transparent;
      background: linear-gradient( rgba(16,24,40,.78), rgba(16,24,40,.74) ) padding-box,
                  linear-gradient(135deg, rgba(97,169,255,.55), rgba(142,245,192,.45)) border-box;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      backdrop-filter: blur(6px) saturate(1.03);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    #team .card.person:hover{ transform: translateY(-3px); box-shadow:0 18px 44px rgba(0,0,0,.45); }
    #team .card.person h3{ margin:6px 0 0; font:800 16px/1.2 system-ui, -apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }
    #team .card.person .role{ margin:0; color:#d7e5ff; font-size:14px; }
    #team .card.person .links{ margin:0; font-size:12px; color:#a9b8d6; }
    #team .card.person .links a{ color:#cfe3ff; text-decoration:underline dotted; }

    /* Avatar (image or initials) */
    .avatar{
      width:96px; height:96px; border-radius:999px; overflow:hidden; display:grid; place-items:center; flex:0 0 auto;
      background:
        radial-gradient(80px 80px at 70% 30%, rgba(142,245,192,.35), transparent 60%),
        radial-gradient(90px 90px at 30% 70%, rgba(97,169,255,.35), transparent 60%),
        #0f1830;
      border:1px solid rgba(60,84,126,.45);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 8px 30px rgba(0,0,0,.35);
      font:800 20px/1 system-ui, -apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; color:#e5edff;
      letter-spacing:.5px;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .avatar[data-initials]:not(:has(img))::after{ content:attr(data-initials); }

    /* Tiny button */
    .btn-mini, .card.person .open-bio{
      display:inline-flex; align-items:center; gap:6px; margin-top:2px;
      padding:6px 10px; border-radius:999px; border:1px solid #2a3b5d;
      background:rgba(17,26,44,.65); color:#d9e7ff; font:700 12px/1 system-ui; cursor:pointer;
    }
    .btn-mini:hover, .card.person .open-bio:hover{ background:rgba(20,30,52,.85); }

    /* Modal (reuses deep-overlay, adds centered card) */
    .team-overlay .frame{ position:absolute; inset:0; }
    .bio-modal{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(760px, calc(100% - 32px)); padding:16px; border-radius:16px;
      border:1px solid rgba(60,84,126,.45);
      background: linear-gradient( rgba(16,24,40,.9), rgba(16,24,40,.88) );
      box-shadow:0 30px 80px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
      color:#e5edff;
    }
    .bio-header{ display:flex; align-items:center; gap:12px; }
    .bio-header .avatar{ width:72px; height:72px; }
    .bio-title h3{ margin:0; font:800 18px/1.2 system-ui, -apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }
    .bio-title .meta{ margin:2px 0 0; color:#a9b8d6; font-size:12px; }
    .bio-body{ margin-top:10px; color:#d8e6ff; }

    /* Make sure overlay close button sits above modal */
    .team-overlay .close{ z-index:3; }
  </style>
</head>
<body>
  <a class="skip" href="#main">Skip to content</a>

  <header class="site-header" role="banner" aria-label="Site header">
    <div class="container header-inner">
      <a class="brand" href="#" aria-label="Home">
        <span>Javad Ghorbani</span>
      </a>
      <nav class="nav" aria-label="Primary">
        <ul>
          <li class="nav-dropdown">
            <a href="#projects">Projects</a>
            <div class="dropdown-menu">
              <div class="dropdown-item has-sub">
                <a href="ai-projects.html">Artificial Intelligence</a>
                <div class="dropdown-submenu">
                  <a href="ai-projects.html#overview">Overview</a>
                  <a href="#ai-demo">Live Demo</a>
                  <a href="#ai-code">Source Code</a>
                  <a href="#ai-paper">Research Paper</a>
                </div>
              </div>
              <div class="dropdown-item has-sub">
                <a href="geomechanics-projects.html">Computational Geomechanics</a>
                <div class="dropdown-submenu">
                  <a href="#geomechanics-sim">Interactive Simulation</a>
                  <a href="#geomechanics-docs">Documentation</a>
                  <a href="#geomechanics-research">Research</a>
                </div>
              </div>
            </div>
          </li>
          <li><a href="#about">About</a></li>
          <li><a class="btn btn-sm" href="#contact-me">Contact</a></li>
        </ul>
      </nav>
      <button class="nav-toggle" aria-expanded="false" aria-controls="nav-drawer" aria-label="Open menu">
        <span></span><span></span><span></span>
      </button>
    </div>
    <div id="nav-drawer" class="nav-drawer" hidden>
      <a href="#projects">Projects</a>
      <div class="drawer-submenu">
        <a href="ai-projects.html">• Artificial Intelligence</a>
        <a href="geomechanics-projects.html">• Computational Geomechanics</a>
      </div>
      <a href="#about">About</a>
      <a href="#contact-me" class="btn btn-sm">Contact</a>
    </div>
  </header>

  <main id="main">
    <!-- HERO -->
    <section class="hero" aria-label="Hero">
      <canvas id="bg" aria-hidden="true"></canvas>
      <div class="container hero-inner reveal">
        <div class="hero-content">
          <div class="hero-text">
            <h1>Hi, I'm <span class="accent">Javad Ghorbani</span></h1>
            <p class="lede">I build interactive, explainable systems for geotechnical intelligence, autonomous constitutive modelling, and scientific visualization—bridging physics, data, and design.</p>
            <div class="cta">
              <a class="btn" href="#projects">View projects</a>
              <a class="btn btn-ghost" href="#contact-me">Contact</a>
            </div>
            <ul class="badges" aria-label="Focus areas">
              <li>Computational Geomechanics (FEM, HM/THM)</li>
              <li>AI for Engineering (RL, MCTS, Bayesian)</li>
              <li>Explainable Visualization (D3.js, Three.js)</li>
              <li>Data & Knowledge Graphs (xAI)</li>
            </ul>
          </div>
          <div class="hero-portrait">
            <div class="portrait-img">
              <img src="jg.png" alt="Javad Ghorbani" width="200" height="200" decoding="async" >
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Projects -->
    <section id="projects" class="stripe" aria-label="Projects">
      <div class="container reveal">
        <header style="text-align:center; margin:0 0 10px; padding: 0 0 10px;">
          <h2 style="margin:0 0 6px; background: linear-gradient(135deg, #7bd4ff, #8ef5c0); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;">Selected Projects</h2>
          <p class="lede" style="max-width:80ch; margin:0 auto;">Each interactive animation below highlights a key project. Click to explore the full experience.</p>
        </header>
        <div class="cards reveal">
          <article class="card project-card">
            <div class="card-header">
              <h3>Artificial Intelligence</h3>
              <div class="card-options">
                <button class="options-toggle" aria-label="Project options">⋮</button>
                <div class="options-menu">
                  <a href="ai-projects.html" class="option-link">View Project</a>
                  <a href="#ai-demo" class="option-link">Live Demo</a>
                  <a href="#ai-code" class="option-link">Source Code</a>
                  <a href="#ai-paper" class="option-link">Research Paper</a>
                </div>
              </div>
            </div>
            <p class="lede">Interactive AI systems for modelling, inference, and visualization.</p>
            <div class="card-tags">
              <span class="tag">Machine Learning</span>
              <span class="tag">Neural Networks</span>
              <span class="tag">Knowledge Graphs</span>
            </div>
            <div class="btn-row"><a class="btn" href="ai-projects.html">Explore</a></div>
          </article>
          <article class="card project-card">
            <div class="card-header">
              <h3>Computational Geomechanics</h3>
              <div class="card-options">
                <button class="options-toggle" aria-label="Project options">⋮</button>
                <div class="options-menu">
                  <a href="#geomechanics-sim" class="option-link">Interactive Simulation</a>
                  <a href="#geomechanics-docs" class="option-link">Documentation</a>
                  <a href="#geomechanics-research" class="option-link">Research</a>
                </div>
              </div>
            </div>
            <p class="lede">Physics-based and numerical geomechanics. Project list coming soon.</p>
            <div class="card-tags">
              <span class="tag">FEM Analysis</span>
              <span class="tag">Soil Mechanics</span>
              <span class="tag">Numerical Methods</span>
            </div>
            <div class="btn-row"><a class="btn" href="geomechanics-projects.html">Explore</a></div>
          </article>
        </div>
      </div>
    </section>

    <!-- About -->
    <section id="about" class="how" aria-label="About">
      <div class="container">
        <h2>About</h2>
        <div class="grid-2">
          <article class="card">
            <h3>Bio</h3>
            <p class="lede">Applied scientist and computational geomechanics engineer building production‑grade, explainable AI for the ground. I combine physics‑based modelling (FEM, HM/THM multiphysics, unsaturated soils, contact mechanics) with modern ML (reinforcement learning, surrogate modelling, Bayesian inference, MCTS/PSO) to automate constitutive model formulation, parameter identification, and real‑time ground assessment. I design human‑centered visual analytics that turn complex simulations and data streams into actionable engineering decisions.</p>
            <ul class="check">
              <li>Computational geomechanics: FEM, large‑deformation elasto‑plasticity, SANISAND</li>
              <li>AI/ML for engineering: RL, Bayesian inference, surrogate modelling, MCTS/PSO</li>
              <li>Inverse modelling & calibration: parameter identification, uncertainty quantification</li>
              <li>Data & knowledge: PostgreSQL, knowledge graphs, xAI, provenance</li>
              <li>Interactive visualization & UX: D3.js/Three.js dashboards for engineers</li>
            </ul>
          </article>
          <article class="card">
            <h3>Skills</h3>
            <ul class="badges" style="justify-content:flex-start;">
              <li>Python</li><li>C++</li><li>TypeScript</li><li>React</li><li>D3.js</li><li>Three.js</li>
              <li>PyTorch</li><li>TensorFlow</li><li>NumPy/SciPy</li><li>Pandas</li><li>SymPy</li>
              <li>FEM</li><li>HM/THM</li><li>Constitutive Modelling</li><li>Algorithmic Differentiation</li>
              <li>Reinforcement Learning</li><li>Bayesian Inference</li><li>Surrogate Modelling</li><li>MCTS</li><li>PSO</li>
              <li>PostgreSQL</li><li>Knowledge Graphs</li><li>Neo4j</li><li>xAI</li>
              <li>Docker</li><li>CI/CD</li><li>Chart.js</li>
            </ul>
          </article>
        </div>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact-me" class="contact" aria-label="Contact">
      <div class="container">
        <h2>Contact</h2>
        <div class="grid-2">
          <article class="card">
            <p class="lede">Interested in collaborating or learning more? Reach out and let's chat.</p>
            <div class="btn-row">
              <a class="btn" href="mailto:javad.ghorbani@rmit.edu.au">Email me</a>
              <a class="btn btn-ghost" href="#projects">View projects</a>
            </div>
          </article>
          <article class="card">
            <h3>Links</h3>
            <ul class="check">
              <li><a href="https://www.linkedin.com/in/javad-ghorbani-763b0744" target="_blank" rel="noopener">LinkedIn</a></li>
              <li><a href="https://scholar.google.com.au/citations?user=IAQOSYcAAAAJ" target="_blank" rel="noopener">Google Scholar</a></li>
            </ul>
          </article>
        </div>
      </div>
    </section>

    <!-- GenCAI Multiagent Section -->
    <section id="gencai-multiagent" class="stripe" aria-label="GenCAI multiagent system">
      <div class="container" style="padding:0;">
        <header style="text-align:center; margin: 0 0 10px; padding: 16px 0;">
          <h2 style="margin:0 0 6px; background: linear-gradient(135deg, #7bd4ff, #8ef5c0); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;">Multiagent system for automotact consitituve model formulation, implementation and calibration (GenCAI)</h2>
          <p class="lede" style="max-width:80ch; margin:0 auto;">Step-by-step visualisation of the orchestrated agents for automatic constitutive model formulation, implementation, and calibration.</p>
        </header>

        <style>
          /* Scoped styles for the GenCAI storyboard */
          #gencaiPage{background:#0b0f1a;color:#e7efff}
          #gencaiPage .shell{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;min-height:70vh;box-sizing:border-box}
          #gencaiPage .sidebar{background:rgba(16,24,40,.85);border:1px solid #2b3b57;border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:12px;overflow:auto}
          #gencaiPage .sidebar h1{margin:0;font:800 18px/1.2 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:#9cc2ff}
          #gencaiPage .sidebar .desc{color:#cfe0ff}
          #gencaiPage .controls{display:flex;gap:8px;flex-wrap:wrap}
          #gencaiPage .btn{cursor:pointer;border:1px solid #2b3b57;background:#152038;color:#e7efff;border-radius:8px;padding:8px 12px;font-weight:700}
          #gencaiPage .btn:hover{border-color:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,.15)}
          #gencaiPage .stage-list{display:flex;flex-direction:column;gap:8px}
          #gencaiPage .stage-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #2b3b57}
          #gencaiPage .stage-item.active{border-color:#60a5fa;background:rgba(96,165,250,.08)}
          #gencaiPage .stage-item .dot{width:10px;height:10px;border-radius:50%;background:#64748b}
          #gencaiPage .stage-item.active .dot{background:#60a5fa}
          #gencaiPage .canvas{background:radial-gradient(1200px 800px at 50% 10%,#0e1628 0%,#0b0f1a 60%,#090e18 100%);border:1px solid #2b3b57;border-radius:12px;padding:16px;position:relative}
          #gencaiPage .panel{position:absolute;inset:16px;overflow:auto;padding-top:56px}
          #gencaiPage .legend{position:absolute;right:8px;top:8px;background:rgba(18,26,44,.85);border:1px solid #334155;border-radius:10px;padding:8px 10px;display:flex;gap:10px;align-items:center}
          #gencaiPage .legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:#cfe0ff}
          #gencaiPage .swatch{width:10px;height:10px;border-radius:3px}
          #gencaiPage .c-el{background:#60a5fa}
          #gencaiPage .c-cs{background:#f59e0b}
          #gencaiPage .c-pl{background:#a855f7}
          #gencaiPage .c-flow{background:#06b6d4}
          #gencaiPage .c-win{background:#10b981}
          #gencaiPage .hint{color:#9fb3d1;font-size:12px}
          @media (max-width:980px){#gencaiPage .shell{grid-template-columns:1fr}}
        </style>

        <div id="gencaiPage">
          <div class="shell">
            <aside class="sidebar">
              <h1>GenCAI — Orchestrator Storyboard</h1>
              <p class="desc">Step-by-step visualisation of the orchestrated agents.</p>
              <div class="controls" role="group" aria-label="Playback controls">
                <button class="btn" id="gencaiPrev" type="button" aria-label="Previous stage">Prev</button>
                <button class="btn" id="gencaiPlay" type="button" aria-label="Play/Pause">Play/Pause</button>
                <button class="btn" id="gencaiNext" type="button" aria-label="Next stage">Next</button>
                <button class="btn" id="gencaiReset" type="button" aria-label="Reset">Reset</button>
              </div>
              <div class="stage-list" id="gencaiStageList"></div>
              <p class="hint">Use ←/→ to step, Space to play/pause, R to reset.</p>
            </aside>
            <main class="canvas">
              <div class="panel" id="gencaiPanel"></div>
            </main>
          </div>
        </div>

        <script>
          (function(){
            const panel = document.getElementById('gencaiPanel');
            const stageList = document.getElementById('gencaiStageList');
            const btnPrev = document.getElementById('gencaiPrev');
            const btnNext = document.getElementById('gencaiNext');
            const btnPlay = document.getElementById('gencaiPlay');
            const btnReset = document.getElementById('gencaiReset');

            const stages = [
              {
                id:'probing',
                title:'1) Feature Probing Agent',
                summary:'Receive raw data (e.g., triaxial tests) and extract Elasticity, Critical State, Plasticity.',
                render:()=>`
                  <div class="legend">
                    <div class="legend-item"><span class="swatch c-el"></span>Elasticity</div>
                    <div class="legend-item"><span class="swatch c-cs"></span>Critical State</div>
                    <div class="legend-item"><span class="swatch c-pl"></span>Plasticity</div>
                    <div class="legend-item"><span class="swatch c-flow"></span>Data Flow</div>
                  </div>
                  <svg viewBox="0 0 1000 540" width="100%" height="520">
                    <g transform="translate(120,260)">
                      <rect x="-80" y="-60" width="160" height="120" rx="14" fill="#16243f" stroke="#334155" stroke-width="2"/>
                      <text x="0" y="-16" text-anchor="middle" fill="#cfe0ff" font-weight="700" font-size="16">Raw Data</text>
                      <text x="0" y="6" text-anchor="middle" fill="#9fb3d1" font-size="12">Triaxial tests</text>
                      <text x="0" y="24" text-anchor="middle" fill="#9fb3d1" font-size="12">Lab curves</text>
                      <text x="0" y="42" text-anchor="middle" fill="#9fb3d1" font-size="12">Sensor logs</text>
                    </g>
                    <g transform="translate(400,260)">
                      <circle r="56" fill="#0f172a" stroke="#475569" stroke-width="3"/>
                      <circle r="38" fill="none" stroke="#60a5fa" stroke-width="4">
                        <animate attributeName="r" values="32;42;32" dur="2s" repeatCount="indefinite"/>
                      </circle>
                      <text x="0" y="6" text-anchor="middle" fill="#cfe0ff" font-weight="700">Probing</text>
                    </g>
                    <g transform="translate(720,170)">
                      <rect x="-110" y="-30" width="220" height="60" rx="12" fill="#14233e" stroke="#60a5fa" stroke-width="2"/>
                      <text x="0" y="4" text-anchor="middle" fill="#cfe0ff" font-weight="700" font-size="16">Elasticity</text>
                    </g>
                    <g transform="translate(720,260)">
                      <rect x="-110" y="-30" width="220" height="60" rx="12" fill="#14233e" stroke="#f59e0b" stroke-width="2"/>
                      <text x="0" y="4" text-anchor="middle" fill="#cfe0ff" font-weight="700" font-size="16">Critical State</text>
                    </g>
                    <g transform="translate(720,350)">
                      <rect x="-110" y="-30" width="220" height="60" rx="12" fill="#14233e" stroke="#a855f7" stroke-width="2"/>
                      <text x="0" y="4" text-anchor="middle" fill="#cfe0ff" font-weight="700" font-size="16">Plasticity</text>
                    </g>
                    <path d="M200,260 C280,260 320,260 344,260" fill="none" stroke="#06b6d4" stroke-width="6" stroke-linecap="round">
                      <animate attributeName="stroke-dasharray" values="0 300;300 300" dur="1.6s" repeatCount="indefinite"/>
                    </path>
                    <path d="M456,260 C560,200 600,180 610,170" fill="none" stroke="#60a5fa" stroke-width="6" stroke-linecap="round">
                      <animate attributeName="stroke-dasharray" values="0 300;300 300" dur="1.8s" repeatCount="indefinite"/>
                    </path>
                    <path d="M456,260 C560,260 600,250 610,250" fill="none" stroke="#f59e0b" stroke-width="6" stroke-linecap="round">
                      <animate attributeName="stroke-dasharray" values="0 300;300 300" dur="1.9s" repeatCount="indefinite"/>
                    </path>
                    <path d="M456,260 C560,320 600,340 610,350" fill="none" stroke="#a855f7" stroke-width="6" stroke-linecap="round">
                      <animate attributeName="stroke-dasharray" values="0 300;300 300" dur="2.0s" repeatCount="indefinite"/>
                    </path>
                  </svg>
                `
              },
              {
                id:'identification',
                title:'2) Parameter Identification Agent',
                summary:'Estimate parameters θ for every candidate using probed data. Outputs fitted candidates (no RMSE).',
                render:()=>`
                  <div class="legend">
                    <div class="legend-item"><span class="swatch" style="background:#ef4444"></span>Undetermined θ</div>
                    <div class="legend-item"><span class="swatch" style="background:#10b981"></span>Calibrated θ</div>
                    <div class="legend-item"><span class="swatch c-flow"></span>Probed data</div>
                  </div>
                  <svg viewBox="0 0 1000 520" width="100%" height="520">
                    <defs>
                      <marker id="arrowBlue" viewBox="0 0 6 6" refX="5" refY="3" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                        <path d="M0,0 L6,3 L0,6 Z" fill="#06b6d4"/>
                      </marker>
                    </defs>
                    <g transform="translate(120,72)"><rect x="0" y="0" width="300" height="44" rx="10" fill="#16243f" stroke="#334155"/><text x="150" y="26" text-anchor="middle" fill="#cfe0ff" font-size="13">Probed Data → {Elasticity, Critical State, Plasticity}</text></g>
                    <g transform="translate(240,148)">
                      <rect x="-140" y="0" width="120" height="58" rx="10" fill="#16243f" stroke="#334155"/>
                      <text x="-80" y="34" text-anchor="middle" fill="#cfe0ff" font-size="12">Probed Elasticity</text>
                      <text x="0" y="-10" fill="#60a5fa" font-weight="800">Elasticity</text>
                      <rect x="0" y="0" width="760" height="58" rx="10" fill="#0f172a" stroke="#334155"/>
                      <g transform="translate(16,10)"><rect width="220" height="38" rx="8" fill="#14233e" stroke="#334155"/><text x="10" y="24" fill="#cfe0ff" font-size="12">Candidate 1</text><g transform="translate(110,11)"><g transform="translate(0,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.6s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.6s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ1</text></g><g transform="translate(32,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.9s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.9s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ2</text></g><g transform="translate(64,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="1.2s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="1.2s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ3</text></g></g></g>
                      <g transform="translate(256,10)"><rect width="220" height="38" rx="8" fill="#14233e" stroke="#334155"/><text x="10" y="24" fill="#cfe0ff" font-size="12">Candidate 2</text><g transform="translate(110,11)"><g transform="translate(0,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.4s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.4s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ1</text></g><g transform="translate(32,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.8s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.8s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ2</text></g><g transform="translate(64,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="1.1s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="1.1s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ3</text></g></g></g>
                      <g transform="translate(496,10)"><rect width="220" height="38" rx="8" fill="#14233e" stroke="#334155"/><text x="10" y="24" fill="#cfe0ff" font-size="12">Candidate 3</text><g transform="translate(110,11)"><g transform="translate(0,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.7s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.7s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ1</text></g><g transform="translate(32,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="1.0s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="1.0s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ2</text></g><g transform="translate(64,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="1.3s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="1.3s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ3</text></g></g></g>
                      <path id="inflow-el" d="M-20,29 L0,29" fill="none" stroke="#06b6d4" stroke-width="3" stroke-linecap="round" marker-end="url(#arrowBlue)"><animate attributeName="stroke-dasharray" values="0 20;20 20" dur="1.2s" repeatCount="indefinite"/></path>
                    </g>
                    <g transform="translate(240,232)">
                      <rect x="-140" y="0" width="120" height="58" rx="10" fill="#16243f" stroke="#334155"/>
                      <text x="-80" y="34" text-anchor="middle" fill="#cfe0ff" font-size="12">Probed Critical</text>
                      <text x="0" y="-10" fill="#f59e0b" font-weight="800">Critical State</text>
                      <rect x="0" y="0" width="760" height="58" rx="10" fill="#0f172a" stroke="#334155"/>
                      <g transform="translate(16,10)"><rect width="240" height="38" rx="8" fill="#14233e" stroke="#334155"/><text x="10" y="24" fill="#cfe0ff" font-size="12">Candidate 1</text><g transform="translate(130,11)"><g transform="translate(0,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.6s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.6s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ1</text></g><g transform="translate(32,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.9s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.9s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ2</text></g></g></g>
                      <g transform="translate(272,10)"><rect width="240" height="38" rx="8" fill="#14233e" stroke="#334155"/><text x="10" y="24" fill="#cfe0ff" font-size="12">Candidate 2</text><g transform="translate(130,11)"><g transform="translate(0,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.5s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.5s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ1</text></g><g transform="translate(32,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.8s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.8s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ2</text></g></g></g>
                      <path id="inflow-cs" d="M-20,29 L0,29" fill="none" stroke="#06b6d4" stroke-width="3" stroke-linecap="round" marker-end="url(#arrowBlue)"><animate attributeName="stroke-dasharray" values="0 20;20 20" dur="1.2s" repeatCount="indefinite"/></path>
                    </g>
                    <g transform="translate(240,334)">
                      <rect x="-140" y="0" width="120" height="58" rx="10" fill="#16243f" stroke="#334155"/>
                      <text x="-80" y="34" text-anchor="middle" fill="#cfe0ff" font-size="12">Probed Plasticity</text>
                      <text x="0" y="-10" fill="#a855f7" font-weight="800">Plasticity</text>
                      <rect x="0" y="0" width="760" height="58" rx="10" fill="#0f172a" stroke="#334155"/>
                      <g transform="translate(16,10)"><rect width="220" height="38" rx="8" fill="#14233e" stroke="#334155"/><text x="10" y="24" fill="#cfe0ff" font-size="12">Candidate 1</text><g transform="translate(110,11)"><g transform="translate(0,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.6s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.6s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ1</text></g><g transform="translate(32,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.9s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.9s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ2</text></g><g transform="translate(64,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="1.2s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="1.2s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ3</text></g></g></g>
                      <g transform="translate(256,10)"><rect width="220" height="38" rx="8" fill="#14233e" stroke="#334155"/><text x="10" y="24" fill="#cfe0ff" font-size="12">Candidate 2</text><g transform="translate(110,11)"><g transform="translate(0,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.5s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.5s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ1</text></g><g transform="translate(32,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.8s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.8s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ2</text></g><g transform="translate(64,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="1.1s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="1.1s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ3</text></g></g></g>
                      <g transform="translate(496,10)"><rect width="220" height="38" rx="8" fill="#14233e" stroke="#334155"/><text x="10" y="24" fill="#cfe0ff" font-size="12">Candidate 3</text><g transform="translate(110,11)"><g transform="translate(0,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="0.7s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="0.7s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ1</text></g><g transform="translate(32,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="1.0s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="1.0s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ2</text></g><g transform="translate(64,0)"><rect width="26" height="16" rx="4" fill="#ef4444" opacity="0.6"><animate attributeName="fill" values="#ef4444;#10b981" begin="1.3s" dur="0.5s" fill="freeze"/><animate attributeName="opacity" values="0.6;1" begin="1.3s" dur="0.5s" fill="freeze"/></rect><text x="13" y="12" text-anchor="middle" fill="#0b0f1a" font-size="11">θ3</text></g></g></g>
                      <path id="inflow-pl" d="M-20,29 L0,29" fill="none" stroke="#06b6d4" stroke-width="3" stroke-linecap="round" marker-end="url(#arrowBlue)"><animate attributeName="stroke-dasharray" values="0 20;20 20" dur="1.2s" repeatCount="indefinite"/></path>
                    </g>
                    <g transform="translate(720,460)"><rect x="-110" y="-20" width="240" height="40" rx="10" fill="#122035" stroke="#334155"/><text x="-98" y="4" fill="#cfe0ff" font-size="12">Output: fitted candidates (θ)</text><text x="-98" y="18" fill="#9fb3d1" font-size="11">Sent to Agent 3 (ranking)</text></g>
                  </svg>
                `
              },
              {
                id:'ranking',
                title:'3) Model Ranking Agent',
                summary:'Compute RMSE per candidate using fitted params; select winners per aspect.',
                render:()=>`
                  <div class="legend">
                    <div class="legend-item"><span class="swatch c-flow"></span>Residuals/data flow</div>
                    <div class="legend-item"><span class="swatch c-win"></span>Winner</div>
                  </div>
                  <svg viewBox="0 0 1000 520" width="100%" height="520">
                    <g transform="translate(120,70)"><rect x="0" y="0" width="260" height="40" rx="10" fill="#16243f" stroke="#334155"/><text x="130" y="24" text-anchor="middle" fill="#cfe0ff" font-size="12">Fitted candidates from Agent 2</text></g>
                    <g transform="translate(820,120)"><rect x="-80" y="-24" width="160" height="48" rx="10" fill="#0f172a" stroke="#334155"/><text x="0" y="4" text-anchor="middle" fill="#cfe0ff" font-weight="800" font-size="12">RMSE Engine</text></g>
                    <g transform="translate(80,190)"><text x="0" y="-12" fill="#60a5fa" font-weight="800">Elasticity</text><rect x="0" y="0" width="480" height="70" rx="12" fill="#0f172a" stroke="#334155"/><g transform="translate(10,10)"><rect x="0" y="8" width="120" height="10" rx="5" fill="#334155"/><rect x="0" y="8" width="120" height="10" rx="5" fill="#06b6d4"/><rect x="0" y="26" width="120" height="10" rx="5" fill="#334155"/><rect x="0" y="26" width="90" height="10" rx="5" fill="#06b6d4"><animate attributeName="width" values="105;90;105" dur="2.6s" repeatCount="indefinite"/></rect><rect x="0" y="44" width="120" height="10" rx="5" fill="#334155"/><rect x="0" y="44" width="150" height="10" rx="5" fill="#06b6d4"/></g></g>
                    <g transform="translate(80,280)"><text x="0" y="-12" fill="#f59e0b" font-weight="800">Critical State</text><rect x="0" y="0" width="480" height="70" rx="12" fill="#0f172a" stroke="#334155"/><g transform="translate(10,10)"><rect x="0" y="8" width="120" height="10" rx="5" fill="#334155"/><rect x="0" y="8" width="80" height="10" rx="5" fill="#06b6d4"/><rect x="0" y="26" width="120" height="10" rx="5" fill="#334155"/><rect x="0" y="26" width="110" height="10" rx="5" fill="#06b6d4"/></g></g>
                    <g transform="translate(80,370)"><text x="0" y="-12" fill="#a855f7" font-weight="800">Plasticity</text><rect x="0" y="0" width="480" height="70" rx="12" fill="#0f172a" stroke="#334155"/><g transform="translate(10,10)"><rect x="0" y="8" width="120" height="10" rx="5" fill="#334155"/><rect x="0" y="8" width="160" height="10" rx="5" fill="#06b6d4"/><rect x="0" y="26" width="120" height="10" rx="5" fill="#334155"/><rect x="0" y="26" width="140" height="10" rx="5" fill="#06b6d4"/><rect x="0" y="44" width="120" height="10" rx="5" fill="#334155"/><rect x="0" y="44" width="130" height="10" rx="5" fill="#06b6d4"/></g></g>
                    <g transform="translate(600,190)">
                      <text x="0" y="-12" fill="#60a5fa" font-weight="800">Elasticity</text>
                      <text x="0" y="8" fill="#cfe0ff" font-size="12">C1: RMSE=0.12</text>
                      <text x="0" y="26" fill="#cfe0ff" font-size="12">C2: RMSE=0.09</text>
                      <text x="0" y="44" fill="#cfe0ff" font-size="12">C3: RMSE=0.15</text>
                    </g>
                    <g transform="translate(600,280)">
                      <text x="0" y="-12" fill="#f59e0b" font-weight="800">Critical State</text>
                      <text x="0" y="8" fill="#cfe0ff" font-size="12">C1: RMSE=0.08</text>
                      <text x="0" y="26" fill="#cfe0ff" font-size="12">C2: RMSE=0.11</text>
                    </g>
                    <g transform="translate(600,370)">
                      <text x="0" y="-12" fill="#a855f7" font-weight="800">Plasticity</text>
                      <text x="0" y="8" fill="#cfe0ff" font-size="12">C1: RMSE=0.20</text>
                      <text x="0" y="26" fill="#cfe0ff" font-size="12">C2: RMSE=0.14</text>
                      <text x="0" y="44" fill="#cfe0ff" font-size="12">C3: RMSE=0.18</text>
                    </g>
                    <g transform="translate(820,260)"><rect x="-80" y="0" width="160" height="40" fill="#122035" stroke="#334155"/><rect x="-80" y="-40" width="160" height="40" fill="#14233e" stroke="#334155"/><rect x="-80" y="-80" width="160" height="40" fill="#1a2332" stroke="#334155"/><text x="0" y="-100" text-anchor="middle" fill="#cfe0ff" font-weight="800">Elasticity Winner</text><g transform="translate(0,-60)"><circle r="14" fill="#10b981"><animate attributeName="cy" values="0;-18;0" dur="2.2s" repeatCount="indefinite"/></circle><text x="0" y="36" text-anchor="middle" fill="#10b981" font-weight="800">Candidate 2</text></g></g>
                    <g transform="translate(820,380)"><rect x="-80" y="0" width="160" height="40" fill="#122035" stroke="#334155"/><rect x="-80" y="-40" width="160" height="40" fill="#1a2332" stroke="#334155"/><rect x="-80" y="-80" width="160" height="40" fill="#14233e" stroke="#334155"/><text x="0" y="-100" text-anchor="middle" fill="#cfe0ff" font-weight="800">Critical State Winner</text><g transform="translate(0,-60)"><circle r="14" fill="#10b981"><animate attributeName="cy" values="0;-18;0" dur="2.2s" begin="0.35s" repeatCount="indefinite"/></circle><text x="0" y="36" text-anchor="middle" fill="#10b981" font-weight="800">Candidate 1</text></g></g>
                    <g transform="translate(820,500)"><rect x="-80" y="0" width="160" height="40" fill="#14233e" stroke="#334155"/><rect x="-80" y="-40" width="160" height="40" fill="#122035" stroke="#334155"/><rect x="-80" y="-80" width="160" height="40" fill="#1a2332" stroke="#334155"/><text x="0" y="-100" text-anchor="middle" fill="#cfe0ff" font-weight="800">Plasticity Winner</text><g transform="translate(0,-60)"><circle r="14" fill="#10b981"><animate attributeName="cy" values="0;-18;0" dur="2.2s" begin="0.7s" repeatCount="indefinite"/></circle><text x="0" y="36" text-anchor="middle" fill="#10b981" font-weight="800">Candidate 2</text></g></g>
                  </svg>
                `
              },
              {
                id:'formulation',
                title:'4) Model Formulation Agent',
                summary:'Place SANISAND building blocks based on winners (E2, CS1, PL2).',
                render:()=>`
                  <div class="legend">
                    <div class="legend-item"><span class="swatch c-el"></span>Elasticity block</div>
                    <div class="legend-item"><span class="swatch c-cs"></span>Critical State block</div>
                    <div class="legend-item"><span class="swatch c-pl"></span>Plasticity block</div>
                  </div>
                  <svg viewBox="0 0 1000 520" width="100%" height="520">
                    <g transform="translate(200,200)"><rect x="0" y="0" width="600" height="260" rx="18" fill="#0f172a" stroke="#334155" stroke-width="3"/><text x="20" y="32" fill="#cfe0ff" font-weight="800" font-size="18">SANISAND Template</text><g transform="translate(20,70)"><rect x="0" y="0" width="560" height="46" rx="10" fill="#122035" stroke="#334155"/><text x="12" y="28" fill="#9fb3d1">Elasticity slot</text></g><g transform="translate(20,130)"><rect x="0" y="0" width="560" height="46" rx="10" fill="#122035" stroke="#334155"/><text x="12" y="28" fill="#9fb3d1">Critical State slot</text></g><g transform="translate(20,190)"><rect x="0" y="0" width="560" height="46" rx="10" fill="#122035" stroke="#334155"/><text x="12" y="28" fill="#9fb3d1">Plasticity slot</text></g></g>
                    <g><rect x="60" y="268" width="140" height="46" rx="10" fill="#60a5fa" stroke="#3b82f6"/><text x="130" y="296" text-anchor="middle" fill="#0b0f1a" font-weight="800">E2</text><animateTransform attributeName="transform" type="translate" from="0 0" to="160 0" dur="2s" fill="freeze"/></g>
                    <g><rect x="60" y="328" width="140" height="46" rx="10" fill="#f59e0b" stroke="#d97706"/><text x="130" y="356" text-anchor="middle" fill="#0b0f1a" font-weight="800">CS1</text><animateTransform attributeName="transform" type="translate" from="0 0" to="160 0" begin="0.4s" dur="2s" fill="freeze"/></g>
                    <g><rect x="60" y="388" width="140" height="46" rx="10" fill="#a855f7" stroke="#7c3aed"/><text x="130" y="416" text-anchor="middle" fill="#0b0f1a" font-weight="800">PL2</text><animateTransform attributeName="transform" type="translate" from="0 0" to="160 0" begin="0.8s" dur="2s" fill="freeze"/></g>
                  </svg>
                `
              },
              {
                id:'calibration',
                title:'5) Global Calibration Agent (PSO)',
                summary:'Swarm converges to global best for final optimization (distinct from local fits).',
                render:()=>`
                  <div class="legend">
                    <div class="legend-item"><span class="swatch c-flow"></span>Particle trajectory</div>
                    <div class="legend-item"><span class="swatch c-win"></span>Global best</div>
                  </div>
                  <svg viewBox="0 0 1000 520" width="100%" height="520">
                    <defs><radialGradient id="space" cx="50%" cy="50%" r="70%"><stop offset="0%" stop-color="#0b1327"/><stop offset="100%" stop-color="#0a1223"/></radialGradient></defs>
                    <rect x="100" y="120" width="680" height="280" rx="16" fill="url(#space)" stroke="#334155" stroke-width="2"/>
                    <text x="120" y="150" fill="#cfe0ff" font-weight="700">Parameter Search Space</text>
                    <g transform="translate(700,220)"><circle r="10" fill="#10b981"><animate attributeName="r" values="8;12;8" dur="1.8s" repeatCount="indefinite"/></circle><text x="14" y="4" fill="#cfe0ff" font-size="12">Global best</text></g>
                    <g>
                      <circle cx="160" cy="360" r="5" fill="#06b6d4"><animate attributeName="cx" values="160;300;460;640;690" dur="7s" repeatCount="indefinite"/><animate attributeName="cy" values="360;300;260;240;220" dur="7s" repeatCount="indefinite"/></circle>
                      <circle cx="220" cy="180" r="5" fill="#06b6d4"><animate attributeName="cx" values="220;360;520;660;700" dur="7.5s" repeatCount="indefinite"/><animate attributeName="cy" values="180;200;210;215;220" dur="7.5s" repeatCount="indefinite"/></circle>
                      <circle cx="260" cy="320" r="5" fill="#06b6d4"><animate attributeName="cx" values="260;380;540;660;700" dur="6.8s" repeatCount="indefinite"/><animate attributeName="cy" values="320;290;260;240;220" dur="6.8s" repeatCount="indefinite"/></circle>
                      <circle cx="200" cy="280" r="5" fill="#06b6d4"><animate attributeName="cx" values="200;340;520;660;700" dur="7.2s" repeatCount="indefinite"/><animate attributeName="cy" values="280;260;240;225;220" dur="7.2s" repeatCount="indefinite"/></circle>
                      <circle cx="240" cy="380" r="5" fill="#06b6d4"><animate attributeName="cx" values="240;380;540;660;700" dur="6.5s" repeatCount="indefinite"/><animate attributeName="cy" values="380;340;280;240;220" dur="6.5s" repeatCount="indefinite"/></circle>
                    </g>
                    <polyline points="120,420 200,380 280,340 360,315 440,290 520,270 600,250 680,238 760,230 800,228" fill="none" stroke="#f59e0b" stroke-width="2"/>
                    <circle r="3" fill="#f59e0b"><animateMotion dur="6s" repeatCount="indefinite" path="M120,420 L200,380 L280,340 L360,315 L440,290 L520,270 L600,250 L680,238 L760,230 L800,228"/></circle>
                  </svg>
                `
              }
            ];

            stages.forEach((s,i)=>{
              const item=document.createElement('div');
              item.className='stage-item';
              item.innerHTML=`<div class="dot"></div><div><div style="font-weight:800">${s.title}</div><div style="color:#cfe0ff">${s.summary}</div></div>`;
              item.addEventListener('click',()=>go(i));
              stageList.appendChild(item);
            });

            let idx=0, playing=false, timer=null;
            function render(){panel.innerHTML=stages[idx].render();[...stageList.children].forEach((el,i)=>el.classList.toggle('active',i===idx));}
            function go(i){idx=Math.max(0,Math.min(stages.length-1,i));render();}
            function next(){go(idx+1)}
            function prev(){go(idx-1)}
            function play(){if(playing){pause();return;}playing=true;timer=setInterval(()=>{if(idx>=stages.length-1){pause();return;}next();},3000)}
            function pause(){playing=false;if(timer)clearInterval(timer);timer=null}
            function reset(){pause();go(0)}

            // Hook controls
            if(btnPrev) btnPrev.addEventListener('click', prev);
            if(btnNext) btnNext.addEventListener('click', next);
            if(btnPlay) btnPlay.addEventListener('click', play);
            if(btnReset) btnReset.addEventListener('click', reset);

            document.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')prev();if(e.key==='ArrowRight')next();if(e.key===' '){e.preventDefault();play();}if(e.key==='r'||e.key==='R')reset();});
            render();
          })();
        </script>
      </div>
    </section>

    <!-- ✨ Interactive Research Pillars -->
    <section id="focus" class="page-focus" aria-label="Research pillars">
      <div class="container">
        <header class="focus-head" role="group" aria-labelledby="focus-title">
          <h2 id="focus-title">Research Pillars</h2>
          <p>Four interconnected capabilities drive Spider's intelligent geotechnical problem-solving.</p>
        </header>

        <div class="pillars-interactive" role="list" aria-label="Interactive research pillars">
          <!-- Pillar 1 -->
          <div class="pillar-item" role="listitem">
            <button class="pillar-toggle" aria-expanded="false" aria-controls="pillar-ai-content">
              <h3>🧠 AI & Knowledge Systems</h3>
              <span class="toggle-icon">▶</span>
            </button>
            <div id="pillar-ai-content" class="pillar-content">
              <p><strong>Symbolic AI meets Machine Learning</strong> - Where physics-based rules and data-driven models collaborate for reliable geotechnical decisions.</p>
              <div class="pillar-highlights">
                <span class="highlight">Typed Knowledge Graph (Σ)</span>
                <span class="highlight">Explainable Provider Selection</span>
                <span class="highlight">Hybrid Rules ↔ ML Pipelines</span>
              </div>
            </div>
          </div>

          <!-- Pillar 2 -->
          <div class="pillar-item" role="listitem">
            <button class="pillar-toggle" aria-expanded="false" aria-controls="pillar-computational-content">
              <h3>🔧 Computational Geomechanics</h3>
              <span class="toggle-icon">▶</span>
            </button>
            <div id="pillar-computational-content" class="pillar-content">
              <p><strong>Physics-anchored numerical methods</strong> - Advanced finite element workflows with constitutive models for real-world soil and rock behavior.</p>
              <div class="pillar-highlights">
                <span class="highlight">Constitutive Law Implementation</span>
                <span class="highlight">Uncertainty Quantification</span>
                <span class="highlight">Multi-scale Model Calibration</span>
              </div>
            </div>
          </div>

          <!-- Pillar 3 -->
          <div class="pillar-item" role="listitem">
            <button class="pillar-toggle" aria-expanded="false" aria-controls="pillar-data-content">
              <h3>📊 Data Intelligence</h3>
              <span class="toggle-icon">▶</span>
            </button>
            <div id="pillar-data-content" class="pillar-content">
              <p><strong>Unified data foundation</strong> - From historical archives to live sensor streams, ensuring data quality and temporal consistency across all sources.</p>
              <div class="pillar-highlights">
                <span class="highlight">Real-time Sensor Integration</span>
                <span class="highlight">Automated Quality Control</span>
                <span class="highlight">Canonical Symbol Mapping (Σ)</span>
              </div>
            </div>
          </div>

          <!-- Pillar 4 -->
          <div class="pillar-item" role="listitem">
            <button class="pillar-toggle" aria-expanded="false" aria-controls="pillar-inverse-content">
              <h3>🎯 Inverse Analysis</h3>
              <span class="toggle-icon">▶</span>
            </button>
            <div id="pillar-inverse-content" class="pillar-content">
              <p><strong>Parameter recovery from observations</strong> - Using Bayesian inference and optimization to identify governing parameters from field measurements.</p>
              <div class="pillar-highlights">
                <span class="highlight">Bayesian Parameter Estimation</span>
                <span class="highlight">Closed-loop Model Updating</span>
                <span class="highlight">Uncertainty Quantification</span>
              </div>
            </div>
          </div>
        </div>

        <div class="focus-cta" role="group" aria-label="Explore system">
          <a class="btn" href="#architecture-canvas">Explore System Architecture →</a>
        </div>
      </div>
    </section>

    <!-- PAGE 2: FORMAL HEADER + INTRO STORY -->
    <section id="page2" class="page2" aria-label="System deep-dive introduction">
      <div class="container">

        <!-- Formal, centered title + description -->
        <header class="section-head" role="group" aria-labelledby="deep-title">
          <h2 id="deep-title" class="title">System Deep‑Dive</h2>
          <p class="lede">Watch the SPIDER engine transform any input into confident, auditable decisions</p>
          <p class="desc">
            What you're about to see is the SPIDER engine at work. The animation visualises how Spider ingests anything,
            translates it into a shared geotechnical symbol set (Σ), chooses the best providers, and explains the result.
          </p>
          <ul class="pillrow" aria-label="Highlights">
            <li class="pill">Typed Σ symbol set</li>
            <li class="pill">Provider registry</li>
            <li class="pill">Assurance traces</li>
            <li class="pill">Physics‑first checks</li>
          </ul>
          <div class="deep-cta" role="group" aria-label="Deep-dive actions">
            <a class="btn" href="#architecture-canvas">Open modules map</a>
            <a class="btn btn-ghost" href="#publications">Design rationale</a>
          </div>
        </header>

          </div>
    </section>

    <!-- ALWAYS-ON ARCHITECTURE CANVAS -->
    <section id="architecture-canvas" class="section section--animation">
      <iframe id="archFrame" src="./system_architecture/system-architecture-interactive.html" loading="lazy" title="Interactive Architecture"></iframe>
    </section>
    
    <!-- SECONDARY 3D SECTION -->
    <section id="system-animation" class="section section--animation" aria-label="Intelligent Geotechnical Solver Animation">
      <div class="container" style="padding:28px 16px 8px;">
        <h2 class="section-title" style="margin:0 0 6px; text-align:center;">Intelligent Geotechnical Solver</h2>
        <p class="lede" style="margin:0; max-width:60ch; text-align:center; margin-inline:auto;">Spider's intelligent geotechnical solver that dynamically selects optimal computation paths, combining physics-based equations, empirical correlations, and ML models to solve complex soil mechanics problems with full traceability and explainability.</p>
      </div>
      <div id="animWrap" class="iframe-wrap" data-active="false">
        <iframe id="animFrame" src="./system-animation-measurement-staged-8x/system-animation-3d-measure-loop.html" loading="lazy" allow="fullscreen" title="Intelligent Geotechnical Solver Animation"></iframe>
        <button id="animVeil" class="iframe-veil" type="button" aria-pressed="false" aria-label="Click to enable 3D canvas interaction">
          <div class="veil-inner">
            <strong>Click to interact</strong>
            <span>Scroll to zoom • drag to orbit</span>
            <small>Click "Exit canvas" or press Esc to return to page scroll</small>
          </div>
        </button>
        <button id="animExit" class="exit-btn" type="button" aria-label="Exit canvas (Esc)">Exit canvas ✕</button>
      </div>
    </section>
    

    <!-- PRACTICAL APPLICATION: Road segment demo -->
    <section id="practical" class="stripe" aria-label="Practical application: road deterioration risk">
      <div class="container">
        <h2>Integrating climate, traffic, soil, and monitoring data for road networks</h2>
        <p class="lede">Australia’s road network faces growing distress from extreme rainfall, heat, heavy freight. A siloed view misses interactions that drive failures like rutting, cracking, and pavement moisture damage. We are working on an integrated approach fuses climate, traffic, soil mechanics, AI and monitoring data to provide a shared context for each segment, enabling earlier detection, targeted maintenance, and more resilient design.</p>
        <div class="grid">
          <div style="position: relative;">
          <div id="map" role="application" aria-label="Map snapshot" style="pointer-events:none"></div>
            <div id="mapControls" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(11,15,26,0.9); border-radius: 8px; padding: 8px; border: 1px solid rgba(60,84,126,0.3);">
              <label style="display: flex; align-items: center; gap: 6px; color: #cfe3ff; font-size: 12px;">
                <input type="checkbox" id="trafficLayer" checked style="margin: 0;" disabled>
                <span>Traffic Layer</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; color: #cfe3ff; font-size: 12px; margin-top: 6px;">
                <input type="checkbox" id="roadOnlyView" style="margin: 0;" disabled>
                <span>Road Only View</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; color: #cfe3ff; font-size: 12px; margin-top: 6px;">
                <input type="checkbox" id="geotechLayer" style="margin: 0;" disabled>
                <span>NSW Geotechnical Tests</span>
              </label>
            </div>
          </div>
          <div class="panel">
            <div class="row">
              <label>
                <span>Start date</span>
                <input type="date" id="paStart" readonly />
              </label>
              <label>
                <span>End date</span>
                <input type="date" id="paEnd" readonly />
              </label>
              </div>
            <div class="row">
              <label>
                <span>Traffic Source</span>
                <select id="paTrafficSource" disabled>
                  <option value="GOOGLE">Google Traffic Layer</option>
                </select>
              </label>
              <label>
                <span>Buffer (km)</span>
                <input type="number" id="paBuffer" min="0.2" step="0.1" value="1.0" disabled />
              </label>
                </div>

            <div class="chips" aria-label="Ingestion status">
              <div id="chipWeather" class="chip">Weather</div>
              <div id="chipTraffic" class="chip">Traffic</div>
              <div id="chipModel" class="chip">Model</div>
                </div>

            

            

            
              </div>
            </div>

        <div class="charts">
          <h3 style="margin:14px 0 8px;">Climate & Traffic</h3>
          <div class="charts-grid">
            <div class="chart-card">
              <div class="small">Daily rainfall (mm)</div>
              <div class="chart-box"><canvas id="chartRain" aria-label="Daily rainfall chart"></canvas></div>
              </div>
            <div class="chart-card">
              <div class="small">Temperature (°C)</div>
              <div class="chart-box"><canvas id="chartTemp" aria-label="Daily temperature chart"></canvas></div>
            </div>
            <div class="chart-card">
              <div class="small">Max wind gust (km/h)</div>
              <div class="chart-box"><canvas id="chartWind" aria-label="Daily wind gust chart"></canvas></div>
            </div>
            <div class="chart-card">
              <div class="small">Traffic Flow Index</div>
              <div class="chart-box"><canvas id="chartTrafficFlow" aria-label="Traffic flow chart"></canvas></div>
            </div>
          </div>

        
        </div>
      </div>
    </section>

    <!-- GROUND ASSESSMENT (RL) -->
    <section id="ground-assessment" class="stripe ground-rl" aria-label="Ground Assessment (Reinforcement Learning)">
      <div class="container">
        <header class="header" style="text-align:center; padding: 24px 0 10px; border-bottom: 1px solid rgba(60,84,126,.25);">
          <h2 style="margin:0 0 6px; background: linear-gradient(135deg, #6aacff, #8ef5c0); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;">Ground Assessment with Reinforcement Learning</h2>
          <p class="lede" style="max-width:68ch; margin:0 auto;">Digital co‑pilot for QA/QC: fuse midpoint measurements with physics‑aware RL to estimate void‑ratio distributions and uncertainty, iteratively learning from observations.</p>
        </header>

        <!-- Styles scoped to this section to avoid collisions -->
        <style>
          .ground-rl .rl-workflow{display:grid;grid-template-columns:200px 1fr 200px;gap:20px;align-items:center;margin:20px 0;padding:20px;background:var(--card);border:1px solid var(--stroke);border-radius:16px;backdrop-filter:blur(8px)}
          .ground-rl .measurements{text-align:center}
          .ground-rl .measurements .icon{width:60px;height:60px;margin:0 auto 10px;background:linear-gradient(135deg,#6aacff,#b49cff);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700}
          .ground-rl .rl-loop{position:relative;display:flex;justify-content:space-around;align-items:center;padding:16px;background:linear-gradient(135deg, rgba(30,45,75,.8), rgba(20,35,60,.6));border:2px solid var(--brand);border-radius:50px;min-height:120px}
          .ground-rl .rl-component{text-align:center;padding:12px;background:#0f182c;border:1px solid var(--stroke);border-radius:12px;transition:.3s;cursor:pointer}
          .ground-rl .rl-component:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.3);border-color:var(--brand)}
          .ground-rl .rl-component.active{border-color:#10b981;background:linear-gradient(135deg, rgba(16,185,129,.1), rgba(20,184,166,.05))}
          .ground-rl .rl-component .icon{width:40px;height:40px;margin:0 auto 8px;background:linear-gradient(135deg,var(--brand),#8ef5c0);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700}
          .ground-rl .rl-component h3{margin:0;font-size:14px;font-weight:700}
          .ground-rl .rl-component p{margin:4px 0 0;font-size:12px;color:var(--muted)}
          .ground-rl .arrow{font-size:24px;color:var(--brand);margin:0 10px}
          .ground-rl .output{text-align:center}
          .ground-rl .output .icon{width:60px;height:60px;margin:0 auto 10px;background:linear-gradient(135deg,#8ef5c0,#ffd66b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700}
          .ground-rl .assessment-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:24px 0}
          .ground-rl .measurement-grid{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px;backdrop-filter:blur(8px)}
          .ground-rl .measurement-grid h3{text-align:center;margin:0 0 12px}
          .ground-rl .grid{display:grid;grid-template-columns:repeat(9,1fr);grid-template-rows:repeat(3,1fr);gap:8px;aspect-ratio:3/1;margin:0 auto;max-width:450px;height:150px}
          .ground-rl .grid-cell{background:rgba(30,45,75,.6);border:1px solid var(--stroke);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:var(--muted);transition:.5s;position:relative;overflow:hidden}
          .ground-rl .measurement-marker{font-size:16px;color:#f59e0b;opacity:.9}
          .ground-rl .grid-cell.cell-measuring{background:linear-gradient(135deg, rgba(96,165,250,.15), rgba(96,165,250,.10));border-color:var(--brand);box-shadow:0 0 0 2px rgba(96,165,250,.8), 0 0 18px rgba(96,165,250,.45)}
          .ground-rl .grid-cell.cell-measured{background:linear-gradient(135deg,#10b981, rgba(16,185,129,.3));border-color:#10b981;box-shadow:0 0 15px rgba(16,185,129,.3)}
          .ground-rl .violin-container{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px;backdrop-filter:blur(8px);min-height:200px}
          .ground-rl .violin-container h2{text-align:center;margin:0 0 12px}
          .ground-rl #violin-plot{width:100%;height:160px;background:rgba(15,22,36,.5);border-radius:8px;border:1px solid var(--stroke)}
          .ground-rl .status{display:flex;justify-content:center;gap:20px;margin:12px 0;flex-wrap:wrap}
          .ground-rl .status-item{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:20px;background:rgba(20,32,56,.8);border:1px solid var(--stroke);font-size:14px;color:var(--muted)}
          .ground-rl .status-item.active{background:linear-gradient(135deg,#10b981, rgba(16,185,129,.2));border-color:#10b981;color:var(--fg)}
          .ground-rl .status-dot{width:8px;height:8px;border-radius:50%;background:var(--muted)}
          .ground-rl .status-item.active .status-dot{background:#10b981;box-shadow:0 0 10px #10b981}
          .ground-rl .axis text{fill:var(--fg);font-size:10px}
          .ground-rl .axis path, .ground-rl .axis line{stroke:rgba(99,123,168,0.35)}
          @media (max-width: 768px){
            .ground-rl .rl-workflow{grid-template-columns:1fr;gap:20px}
            .ground-rl .rl-loop{flex-direction:column;gap:12px}
            .ground-rl .arrow{transform:rotate(90deg);margin:10px 0}
            .ground-rl .assessment-layout{grid-template-columns:1fr;gap:16px}
            .ground-rl .grid{grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(5,1fr);gap:6px}
          }
          @media (max-width: 480px){
            .ground-rl .grid{grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(9,1fr);gap:4px}
            .ground-rl .grid-cell{font-size:10px;padding:2px}
          }
        </style>

        <!-- RL Workflow Visualization -->
        <section class="rl-workflow">
          <div class="measurements">
            <div class="icon">📊</div>
            <h3>Measurements</h3>
            <p>Soil parameters, environmental data, and site conditions</p>
          </div>
          <div class="rl-loop">
            <div class="rl-component active" id="measurement">
              <div class="icon" aria-hidden="true">🔎</div>
              <h3>Measurement</h3>
              <p>Collect soil measurements at grid midpoints</p>
            </div>
            <div class="arrow">→</div>
            <div class="rl-component" id="estimation">
              <div class="icon">📊</div>
              <h3>Estimation</h3>
              <p>Predict void ratio for measured cell</p>
            </div>
            <div class="arrow">→</div>
            <div class="rl-component" id="learning">
              <div class="icon">🧠</div>
              <h3>Learning</h3>
              <p>Update policy from measurement vs prediction</p>
            </div>
          </div>
          <div class="output">
            <div class="icon">📈</div>
            <h3>Void Ratio Analysis</h3>
            <p>Optimized void ratio distributions</p>
          </div>
        </section>

        <!-- Assessment Layout: Grid + Violin Plot -->
        <div class="assessment-layout">
          <div class="measurement-grid">
            <h3>Measurement Grid (3×9)</h3>
            <div class="grid" id="measurementGrid"></div>
          </div>
          <div class="violin-container">
            <h2>Void Ratio Analysis</h2>
            <div id="violin-plot"></div>
          </div>
        </div>

        <!-- Status Row -->
        <div class="status">
          <div class="status-item active" id="measurementStatus"><div class="status-dot"></div><span>Measurement</span></div>
          <div class="status-item" id="estimationStatus"><div class="status-dot"></div><span>Estimation</span></div>
          <div class="status-item" id="learningStatus"><div class="status-dot"></div><span>Learning</span></div>
        </div>
      </div>
    </section>

    <!-- SELF-PLAY + MCTS PARAMETER IDENTIFICATION -->
    <section id="alpha-calibration" class="stripe alpha-anim" aria-label="Self-Play and MCTS parameter identification">
      <div class="container">
        <header style="text-align:center; margin-bottom: 10px;">
          <h2 style="margin:0 0 6px; background: linear-gradient(135deg, #7bd4ff, #8ef5c0); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;">AlphaGeo — Constitutive Modeling Automation and Automatic Calibration</h2>
          <p class="lede" style="max-width:80ch; margin:0 auto;">AlphaGeo is a multi‑agent system that automates traditionally demanding tasks in geotechnical modeling—constitutive model setup, parameter identification, and calibration. In this demo, AlphaGeo: (1) samples parameters and initial conditions within bounds (Explorer), (2) builds a surrogate dataset from states S and deltas D (Self‑Play), (3) trains a model f: X→ΔA to predict parameter adjustments (Learner), and (4) refines adjustments with MCTS to minimize calibration error.</p>
        </header>
        <div class="deep-cta" role="group" aria-label="Open orchestrator animation">
          <button class="btn btn-ghost" id="openOrchestrator">Open Orchestrator Animation</button>
        </div>

        <style>
          .alpha-anim .grid-anim{ display:grid; gap:14px; }
          .alpha-anim .grid-anim-1{ grid-template-columns: 1fr; justify-items: center; }
          .alpha-anim .grid-anim-2{ grid-template-columns: 1fr 1fr; }
          .alpha-anim .grid-anim-3{ grid-template-columns: 1fr 1fr 1fr; }
          .alpha-anim .card-plot{ background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:10px; box-shadow: var(--shadow); }
          .alpha-anim .card-plot h3{ margin: 0 0 6px; font-size: 16px; }
          .alpha-anim .meta-row{ display:flex; gap:10px; flex-wrap:wrap; color:#a9b8d6; font-size:12px; margin:6px 0 0; }
          .alpha-anim .card-plot.narrow{ width:min(720px, 100%); }
          @media (max-width: 1100px){ .alpha-anim .grid-anim-3{ grid-template-columns: 1fr 1fr; } }
          @media (max-width: 900px){ .alpha-anim .grid-anim-3, .alpha-anim .grid-anim-2, .alpha-anim .grid-anim-1{ grid-template-columns: 1fr; } }
        </style>
        <!-- Row 1: Explorer + Self-Play -->
        <div class="grid-anim grid-anim-2">
          <article class="card-plot">
            <h3>Explorer Agent (adjust A, G within bounds)</h3>
            <p class="micro" style="margin:2px 0 8px; color:#a9b8d6;">
              Explorer samples A (model parameters [a₁..a_M]) and G (initial conditions [g₁..g_NIC]) within their bounds. Each sample yields a prediction yᵢ and a delta Δyᵢ = yᵢ − y₀ (vs baseline y₀). States are S = {(x, y₀)} and deltas are D = {Δyᵢ}; together they form X = {S, D} for the learner.
            </p>
            <div id="explorerSvg" role="img" aria-label="Explorer agent parameter adjustments"></div>
          </article>
          <article class="card-plot">
            <h3>Self‑Play Trials (build X={S,D}, Y=ΔA)</h3>
            <p class="micro" style="margin:2px 0 8px; color:#a9b8d6;">
              X collects states S and differences D where S = {(x, y₀)} are baseline input‑output pairs, D = {Δyᵢ} are per‑trial prediction deltas; A are model parameters [a₁..a_M]; G are initial conditions [g₁..g_NIC].
            </p>
            <div id="selfplaySvg" role="img" aria-label="Self-play trials plot"></div>
            <div class="meta-row" id="alphaMetaLeft" aria-live="polite"></div>
          </article>
        </div>

        <!-- Row 2: Learner centered -->
        <div class="grid-anim grid-anim-1" style="margin-top: 14px;">
          <article class="card-plot narrow">
            <h3>Learner Agent (train surrogate f: X → ΔA)</h3>
            <div id="learnerSvg" role="img" aria-label="Learner agent training visualization"></div>
          </article>
        </div>

        <div class="grid-anim grid-anim-2" style="margin-top: 14px;">
          <!-- MCTS panel -->
          <article class="card-plot">
            <h3>MCTS (selection → expansion → simulation → backprop)</h3>
            <div id="mctsSvg" role="img" aria-label="MCTS tree visualization"></div>
            <div class="meta-row" id="alphaMetaRight" aria-live="polite"></div>
          </article>

          <!-- Final parameters panel -->
          <article class="card-plot">
            <h3>Final Parameter Finding</h3>
            <div id="finalSvg" role="img" aria-label="Final parameters and curve"></div>
          </article>
        </div>
      </div>
    </section>

    <!-- Deep-dive overlay (parent-owned) -->
    <div id="deepOverlay" class="deep-overlay" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Module Deep Dive Overlay">
      <div class="scrim" id="deepScrim"></div>
      <div class="frame">
        <iframe id="deepFrame" title="Deep Dive"></iframe>
      </div>
      <div id="deepMeta" class="meta-links" hidden>
        <a id="deepPub" href="#" target="_blank" rel="noopener">Publication</a>
        <a id="deepRepo" href="#" target="_blank" rel="noopener">Repository</a>
      </div>
      <button id="deepClose" class="close" type="button" aria-label="Close deep dive (Esc)">Exit ✕</button>
    </div>

    <script>
      // Ensure GenCAI section appears right after AlphaGeo overlay
      (function(){
        try{
          var gencai = document.getElementById('gencai-multiagent');
          var overlay = document.getElementById('deepOverlay');
          if (gencai && overlay && overlay.parentNode) {
            overlay.parentNode.insertBefore(gencai, overlay.nextSibling);
          }
        }catch(e){}
      })();
    </script>
    <script>
      // Ensure System Deep‑Dive (page2) appears right after GenCAI
      (function(){
        try{
          var sys = document.getElementById('page2');
          var gencai = document.getElementById('gencai-multiagent');
          if (sys && gencai && gencai.parentNode) {
            gencai.parentNode.insertBefore(sys, gencai.nextSibling);
          }
        }catch(e){}
      })();
    </script>
    <script>
      // Ensure Architecture Canvas appears right after System Deep‑Dive
      (function(){
        try{
          var arch = document.getElementById('architecture-canvas');
          var sys = document.getElementById('page2');
          if (arch && sys && sys.parentNode) {
            sys.parentNode.insertBefore(arch, sys.nextSibling);
          }
        }catch(e){}
      })();
      // Ensure 3D solver animation appears right after Architecture Canvas
      (function(){
        try{
          var anim = document.getElementById('system-animation');
          var arch = document.getElementById('architecture-canvas');
          if (anim && arch && arch.parentNode) {
            arch.parentNode.insertBefore(anim, arch.nextSibling);
          }
        }catch(e){}
      })();
    </script>

    

    <!-- REPOSITORIES -->
    <section id="repositories" class="stripe" aria-label="Repositories">
      <div class="container">
        <h2>Repositories</h2>
        <p>Everything is developed in the open. Explore the codebases below and get involved via issues and discussions.</p>
        <div class="repo-list">
          <article class="card">
            <h3>spider-core</h3>
            <p>Symbolic inference engine, provider registry, and reasoning orchestration.</p>
            <div class="meta">License: Apache-2.0 • Lang: TypeScript/Python</div>
            <div class="btn-row">
              <a class="btn btn-sm" href="#" aria-label="Open spider-core on GitHub">GitHub</a>
              <a class="btn btn-ghost btn-sm" href="#" aria-label="Open spider-core docs">Docs</a>
            </div>
          </article>
          <article class="card">
            <h3>spider-kg</h3>
            <p>Typed geotechnical knowledge graph: schemas, loaders, and validation tooling.</p>
            <div class="meta">License: Apache-2.0 • Lang: Python</div>
            <div class="btn-row">
              <a class="btn btn-sm" href="#">GitHub</a>
              <a class="btn btn-ghost btn-sm" href="#">Docs</a>
            </div>
          </article>
          <article class="card">
            <h3>spider-viz</h3>
            <p>Explainability UIs and provenance explorers for audits and reviews.</p>
            <div class="meta">License: MIT • Lang: TypeScript</div>
            <div class="btn-row">
              <a class="btn btn-sm" href="#">GitHub</a>
              <a class="btn btn-ghost btn-sm" href="#">Docs</a>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- PUBLICATIONS (renamed from whitepaper) -->
    <section id="publications" class="stripe" aria-label="Related publications">
      <div class="container">
        <h2>Related publications</h2>
        <div class="pub-list">
          <article class="card">
            <h3>Knowledge-driven Geotechnical Reasoning with Symbolic Inference</h3>
            <p class="meta">Conference/Journal • 2024 • <a href="#">DOI</a></p>
            <p>Describes the Spider approach to unifying domain rules, physics, and machine learning in a reproducible pipeline.</p>
          </article>
          <article class="card">
            <h3>Trustworthy AI for Infrastructure Engineering</h3>
            <p class="meta">Preprint • 2025 • <a href="#">arXiv</a></p>
            <p>Outlines assurance cases, provenance tracking, and standards alignment for safety-critical decisions.</p>
          </article>
        </div>
      </div>
    </section>

    <!-- RESEARCH TEAM (UPDATED) -->
    <section id="team" class="stripe" aria-label="Research team">
      <div class="container">
        <header class="team-head">
          <h2>Research team</h2>
          <p class="lede">Engineers and researchers building explainable geotechnical intelligence.</p>
        </header>

        <div class="people" role="list">
          <!-- Person 1 -->
          <article class="card person" role="listitem">
            <figure class="avatar" data-initials="AE" aria-hidden="true">
              <!-- Optional real photo: <img src="assets/people/alex.jpg" alt="" loading="lazy"> -->
            </figure>
            <h3>Dr. Alex Example</h3>
            <p class="role">Principal Investigator — Knowledge Systems</p>
            <p class="links meta"><a href="#">Profile</a> • <a href="#">Google Scholar</a></p>
            <button class="open-bio" type="button" aria-haspopup="dialog" aria-controls="teamOverlay">View bio</button>

            <!-- Hidden bio content (pulled into modal on click) -->
            <div class="bio" hidden>
              <p>Alex leads Spider's knowledge-driven stack: typed ontologies, assurance cases, and hybrid reasoning pipelines. Previously at ExampleLab and Uni Example.</p>
              <ul>
                <li>PhD, Geotechnical AI — Uni Example</li>
                <li>Focus: symbolic inference, provenance, safety cases</li>
              </ul>
            </div>
          </article>

          <!-- Person 2 -->
          <article class="card person" role="listitem">
            <figure class="avatar" data-initials="JT" aria-hidden="true"></figure>
            <h3>Jamie Taylor</h3>
            <p class="role">Lead Engineer — Symbolic Reasoning</p>
            <p class="links meta"><a href="#">Profile</a> • <a href="#">GitHub</a></p>
            <button class="open-bio" type="button" aria-haspopup="dialog" aria-controls="teamOverlay">View bio</button>
            <div class="bio" hidden>
              <p>Jamie designs the rule engine and provider registry for auditability and speed, focusing on typed KGs and verifiable explanations.</p>
            </div>
          </article>

          <!-- Person 3 -->
          <article class="card person" role="listitem">
            <figure class="avatar" data-initials="CM" aria-hidden="true"></figure>
            <h3>Casey Morgan</h3>
            <p class="role">Research Fellow — Geotechnical Modelling</p>
            <p class="links meta"><a href="#">Profile</a> • <a href="#">Google Scholar</a></p>
            <button class="open-bio" type="button" aria-haspopup="dialog" aria-controls="teamOverlay">View bio</button>
            <div class="bio" hidden>
              <p>Casey bridges field data and computational mechanics, calibrating constitutive models and building uncertainty-aware checks.</p>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- Team Bio Overlay -->
    <div id="teamOverlay" class="deep-overlay team-overlay" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Team member bio">
      <div class="scrim" id="teamScrim"></div>
      <div class="frame">
        <div id="teamModal" class="bio-modal" role="document" aria-live="polite"></div>
      </div>
      <button id="teamClose" class="close" type="button" aria-label="Close bio (Esc)">Close ✕</button>
    </div>

    
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div class="brand-row"><strong>Javad Ghorbani</strong></div>
      <nav aria-label="Footer">
        <a href="#projects">Projects</a>
        <a href="ai-projects.html">Artificial Intelligence</a>
        <a href="#about">About</a>
        <a href="#contact-me">Contact</a>
      </nav>
      <p class="micro">© <span id="year"></span> Javad Ghorbani. All rights reserved.</p>
    </div>
  </footer>

  <!-- Page scripts -->
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- Portfolio: lightbox overlay launcher for project iframes -->
  <script>
    (function(){
      var overlay = document.getElementById('deepOverlay');
      var frame = document.getElementById('deepFrame');
      var closeBtn = document.getElementById('deepClose');
      var scrim = document.getElementById('deepScrim');
      function openOverlay(url){ if (!overlay || !frame) return; frame.src = url; overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
      function closeOverlay(){ if (!overlay || !frame) return; overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); frame.removeAttribute('src'); document.body.style.overflow=''; }
      var deepMeta = document.getElementById('deepMeta');
      var deepPub = document.getElementById('deepPub');
      var deepRepo = document.getElementById('deepRepo');
      var projectMeta = {
        'alphageo.html': { pub: '#', repo: '#' },
        'system_architecture/system-architecture-interactive.html': { pub: '#', repo: '#' },
        'road-networks.html': { pub: 'TRAFFIC_DATA_README.md', repo: '#' },
        'ground-assessment-rl.html': { pub: '#', repo: '#' },
        'gencai-multiagent-animation.html': { pub: '#', repo: '#' }
      };
      // If landing with a project page URL, show meta with placeholders
      (function initMetaFromLocation(){
        if (!deepMeta || !deepPub || !deepRepo) return;
        var path = (window.location.pathname||'').split('/').pop();
        var meta = projectMeta[path];
        if (meta){ deepMeta.hidden = false; deepPub.href = meta.pub; deepRepo.href = meta.repo; }
      })();
      document.addEventListener('click', function(e){
        var tScroll = e.target.closest('.iframe-veil[data-scroll-target]');
        if (tScroll){ e.preventDefault(); var sel = tScroll.getAttribute('data-scroll-target'); var el = document.querySelector(sel); if (el){ el.scrollIntoView({behavior:'smooth'}); } }
      });
      closeBtn && closeBtn.addEventListener('click', closeOverlay);
      scrim && scrim.addEventListener('click', closeOverlay);
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeOverlay(); });
    })();
  </script>

  <!-- Google Maps JavaScript API -->
  <!-- IMPORTANT: Replace the API key below with your own Google Maps API key -->
  <!-- This demo key may not work - get your key at: https://console.developers.google.com/ -->
  <!-- Required APIs: Maps JavaScript API, Roads API, Traffic Layer -->
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- Google Maps MarkerClusterer -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

  <!-- Mobile nav drawer toggle (accessibility + scroll lock) -->
  <script>
    (function(){
      const btn = document.querySelector('.nav-toggle');
      const drawer = document.getElementById('nav-drawer');
      if (!btn || !drawer) return;

      function open() {
        drawer.hidden = false;
        btn.setAttribute('aria-expanded','true');
        document.documentElement.style.overflow = 'hidden';
        drawer.focus && drawer.focus();
      }
      function close() {
        drawer.hidden = true;
        btn.setAttribute('aria-expanded','false');
        document.documentElement.style.overflow = '';
        btn.focus && btn.focus();
      }

      btn.addEventListener('click', () => drawer.hidden ? open() : close());
      // Close drawer when clicking a link
      drawer.addEventListener('click', (e) => {
        const t = e.target;
        if (t && t.tagName === 'A') close();
      });
      window.addEventListener('keydown', e => { if (e.key === 'Escape' && !drawer.hidden) close(); });
    })();
  </script>

  <!-- Enable/disable 3D iframe interaction (secondary section) -->
  <script>
    (function(){
      const wrap  = document.getElementById('animWrap');
      const veil  = document.getElementById('animVeil');
      const exit  = document.getElementById('animExit');
      const section = document.getElementById('system-animation');
      if (!wrap || !veil || !exit || !section) return;

      const activate = () => {
        wrap.classList.add('active');
        wrap.dataset.active = 'true';
        veil.setAttribute('aria-pressed','true');
      };

      const deactivate = (reason) => {
        wrap.classList.remove('active');
        wrap.dataset.active = 'false';
        veil.setAttribute('aria-pressed','false');
        // return focus to veil for accessibility, but prevent page jump
        if (veil && veil.focus) veil.focus({ preventScroll: true });
      };

      // expose controls globally so other modules/overlays can deactivate safely
      window.SpiderAnim = {
        activate, deactivate,
        isActive: () => wrap.classList.contains('active')
      };

      veil.addEventListener('click', (e) => { e.preventDefault(); activate(); });
      exit.addEventListener('click', (e) => { e.preventDefault(); deactivate('manual-exit'); });

      // Click outside to deactivate
      document.addEventListener('click', (e) => {
        if (!wrap.classList.contains('active')) return;
        if (!wrap.contains(e.target)) deactivate('outside-click');
      }, true);

      // Esc to deactivate when active
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && wrap.classList.contains('active')) deactivate('esc');
      }, true);

      // Auto-deactivate when the section scrolls out of view
      const deactivateIfOutOfView = (why) => {
        if (!wrap.classList.contains('active')) return;
        const rect = section.getBoundingClientRect();
        const vh = window.innerHeight || document.documentElement.clientHeight;
        const notVisible = rect.bottom < 0 || rect.top > vh || rect.height === 0;
        if (notVisible) deactivate(why);
      };

      // IntersectionObserver (preferred)
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (!entry.isIntersecting || entry.intersectionRatio < 0.15) {
              deactivate('io-out-of-view');
            }
          });
        }, { threshold: [0, 0.15, 0.5] });
        io.observe(section);
      }

      // Fallbacks: visibility + scroll
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) deactivate('tab-hidden');
      });

      let tick = false;
      window.addEventListener('scroll', () => {
        if (tick) return;
        tick = true;
        requestAnimationFrame(() => { tick = false; deactivateIfOutOfView('scrolled-away'); });
      }, { passive: true });
    })();
  </script>

  <!-- Parent-owned deep-dive overlay + binding into the architecture iframe (with focus trap) -->
  <script>
    (function(){
      const overlay = document.getElementById('deepOverlay');
      const deepFrame = document.getElementById('deepFrame');
      const deepClose = document.getElementById('deepClose');
      const deepScrim = document.getElementById('deepScrim');
      const archFrame = document.getElementById('archFrame');
      let lastFocus = null;

      function trapFocus(e){
        if (e.key !== 'Tab') return;
        const focusables = overlay.querySelectorAll('a,button,input,textarea,select,[tabindex]:not([tabindex="-1"])');
        if (!focusables.length) return;
        const first = focusables[0], last = focusables[focusables.length-1];
        if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
        else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
      }

      function openDeep(url){
        if (!url) return;
        // Ensure secondary animation is inactive before opening overlay
        if (window.SpiderAnim && window.SpiderAnim.isActive()) {
          window.SpiderAnim.deactivate('deep-overlay-open');
        }
        lastFocus = document.activeElement;
        deepFrame.src = url;
        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden','false');
        document.documentElement.style.overflow = 'hidden';
        overlay.addEventListener('keydown', trapFocus);
        try { deepClose.focus(); } catch(_) {}
      }
      // expose opener for page-level buttons
      window.SpiderOpenDeep = openDeep;

      function closeDeep(){
        deepFrame.src = 'about:blank';
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden','true');
        document.documentElement.style.overflow = '';
        overlay.removeEventListener('keydown', trapFocus);
        if (lastFocus && lastFocus.focus) lastFocus.focus();
      }

      deepClose.addEventListener('click', closeDeep);
      deepScrim.addEventListener('click', closeDeep);
      window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && overlay.classList.contains('active')) closeDeep(); });

      // Map canvas node IDs to deep-dive pages
      const DEEP_LINKS = {
        inputs:   './system_architecture/input-animation.html',
        parser:   './system_architecture/Parser_animation.html',
        registry: './system_architecture/provider_animation.html',
        reasoner: './system_architecture/hypergraph_animation.html',
        dynmem:   './system_architecture/dynamic_memory_animation.html',
        pool:     './system_architecture/pool_animation.html',
        output:     './system_architecture/output_animation.html',
        orchestrator: './system_architecture/orchestrator_animation.html'
      };

      // Accept 'exit' from child deep-dive pages and open-requests from architecture
      window.addEventListener('message', (e)=>{
        const d = e.data || {};
        if ((d.source === 'spider-anim' || d.kind === 'spider-anim') && d.cmd === 'exit') closeDeep();
        if (d.source === 'system-architecture' && d.cmd === 'open'){ const url = d.url || DEEP_LINKS[d.target]; if (url) openDeep(url); }
      });

      // Bind click handlers *inside* the architecture iframe (same-origin expected)
      function bindIntoArchitecture(){
        try{
          const doc = archFrame.contentDocument || archFrame.contentWindow.document; if (!doc) return;
          const childOverlay = doc.getElementById('overlay'); if (childOverlay) childOverlay.style.display = 'none';
          function hook(id, url){
            const el = doc.getElementById(id); if (!el || !url || el.dataset.bound === '1') return;
            const handler = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); openDeep(url); };
            el.addEventListener('click', handler, true);
            el.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter' || ev.key === ' ') handler(ev); }, true);
            el.dataset.bound = '1';
          }
          hook('inputs',   DEEP_LINKS.inputs);
          hook('parser',   DEEP_LINKS.parser);
          hook('registry', DEEP_LINKS.registry);
          hook('reasoner', DEEP_LINKS.reasoner);
          hook('dynmem',   DEEP_LINKS.dynmem);
          hook('pool',     DEEP_LINKS.pool);
          hook('output',     DEEP_LINKS.output);
          hook('orchestrator', DEEP_LINKS.orchestrator);
          const panel = doc.getElementById('panel'); if (panel) panel.style.display = 'none';
        }catch(err){ /* likely cross-origin; ignore */ }
      }
      archFrame.addEventListener('load', bindIntoArchitecture);
    })();
  </script>

  <!-- Interactive Research Pillars -->
  <script>
    (function(){
      // Interactive pillars expand/collapse functionality
      const pillarToggles = document.querySelectorAll('.pillar-toggle');

      pillarToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          const contentId = this.getAttribute('aria-controls');
          const content = document.getElementById(contentId);

          if (isExpanded) {
            // Collapse
            this.setAttribute('aria-expanded', 'false');
            content.classList.remove('expanded');
          } else {
            // Expand
            this.setAttribute('aria-expanded', 'true');
            content.classList.add('expanded');
          }
        });
      });

      // Keyboard navigation for accessibility
      pillarToggles.forEach(toggle => {
        toggle.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
          }
        });
      });

      // Orchestrator opener button under AlphaGeo section
      const openOrch = document.getElementById('openOrchestrator');
      if (openOrch) openOrch.addEventListener('click', function(){
        try{
          if (window.SpiderOpenDeep) window.SpiderOpenDeep('./system_architecture/orchestrator_animation.html');
        }catch(err){ console.warn('Cannot open orchestrator overlay', err); }
      });
    })();
  </script>

  <!-- Global variables for map management -->
  <script>
    let googleMap = null;
    let trafficLayer = null;
    let startMarker = null, endMarker = null, line = null;
    let trafficCharts = {};
    let geotechMarkers = [];
    let suppressNextMapClick = false;
    let realTimeInterval = null;
    // Tight Sydney bounds to improve performance and limit view
    const SYD_BOUNDS = { north: -33.70, south: -34.10, east: 151.35, west: 150.90 };
    function isInSydney(lat, lon){
      return lat <= SYD_BOUNDS.north && lat >= SYD_BOUNDS.south && lon >= SYD_BOUNDS.west && lon <= SYD_BOUNDS.east;
    }

    // Initialize Google Maps callback
    window.initGoogleMaps = function() {
      console.log('Google Maps loaded');
      // The initGoogleMap function will be called from within the IIFE below
    };

    (function(){
      const mapEl = document.getElementById('map');
      const runBtn = document.getElementById('paRun');
      const resetBtn = document.getElementById('paReset');
      const chipWeather = document.getElementById('chipWeather');
      const chipTraffic = document.getElementById('chipTraffic');
      const chipModel = document.getElementById('chipModel');
      const startEl = document.getElementById('paStart');
      const endEl = document.getElementById('paEnd');
      const trafficSourceEl = document.getElementById('paTrafficSource');
      const bufferEl = document.getElementById('paBuffer');
      const trafficLayerEl = document.getElementById('trafficLayer');
      const geotechLayerEl = document.getElementById('geotechLayer');
      // Live coordinate display in map corner
      const coordDisplay = document.createElement('div');
      coordDisplay.style.cssText = 'position:absolute; left:10px; bottom:10px; z-index:1000; background: rgba(11,15,26,0.9); border:1px solid rgba(60,84,126,0.3); color:#cfe3ff; padding:6px 8px; border-radius:8px; font-size:12px;';
      coordDisplay.setAttribute('aria-live','polite');
      const mapContainer = document.getElementById('map')?.parentElement;
      if (mapContainer) mapContainer.appendChild(coordDisplay);

      if (!mapEl || !runBtn) return;
      // Initially disable Run until a segment is defined
      try { runBtn.disabled = true; } catch {}

      // Init dates: last 30 days
      const today = new Date();
      const past = new Date(Date.now() - 29*24*3600*1000);
      startEl.value = past.toISOString().slice(0,10);
      endEl.value = today.toISOString().slice(0,10);

      // Enable/disable Run button based on whether a segment exists
      function updateRunEnabled(){ try { runBtn.disabled = !ensureLine(); } catch {} }

      // Function to initialize map when Google Maps is ready
      function initializeMapWhenReady() {
        if (typeof google !== 'undefined' && google.maps) {
          console.log('Google Maps API loaded successfully');
          try {
            initGoogleMap();
          } catch (error) {
            console.error('Error initializing Google Maps:', error);
            mapEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #cfe3ff; background: rgba(11,15,26,0.9); border-radius: 8px;">Error loading Google Maps. Please check your API key and network connection.</div>';
          }
        } else {
          console.log('Waiting for Google Maps API to load...');
          // Wait for Google Maps to load (max 10 seconds)
          setTimeout(initializeMapWhenReady, 100);
        }
      }

      // Start initialization process
      initializeMapWhenReady();

      // Road-only map styling
      const roadOnlyStyles = [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "poi.business",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "poi.government",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "poi.medical",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "poi.park",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "poi.place_of_worship",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "poi.school",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "poi.sports_complex",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "landscape",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "landscape.man_made",
          elementType: "geometry",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "landscape.natural",
          elementType: "geometry",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "administrative",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "administrative.locality",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "water",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "transit",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ];

      // Function to snap point to nearest road
      async function snapToRoad(latLng) {
        try {
          const response = await fetch(`https://roads.googleapis.com/v1/nearestRoads?points=${latLng.lat()},${latLng.lng()}&key=REDACTED`);
          const data = await response.json();

          if (data.snappedPoints && data.snappedPoints.length > 0) {
            const snappedPoint = data.snappedPoints[0].location;
            return new google.maps.LatLng(snappedPoint.latitude, snappedPoint.longitude);
          }
        } catch (error) {
          console.warn('Road snapping failed, using original point:', error);
        }
        return latLng; // Return original point if snapping fails
      }


      // Initialize Google Maps
      function initGoogleMap() {
        const mapOptions = {
          center: { lat: -33.8688, lng: 151.2093 },
          zoom: 12,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
          restriction: { latLngBounds: SYD_BOUNDS, strictBounds: true }
        };

        // Apply road-only styling if enabled
        const roadOnlyEl = document.getElementById('roadOnlyView');
        if (roadOnlyEl && roadOnlyEl.checked) {
          mapOptions.styles = roadOnlyStyles;
        }

        googleMap = new google.maps.Map(mapEl, mapOptions);

        // Add traffic layer
        if (trafficLayerEl.checked) {
          trafficLayer = new google.maps.TrafficLayer();
          trafficLayer.setMap(googleMap);
        }

        // Setup click handlers
        setupMapClickHandlers();
        updateRunEnabled();

        console.log('Google Maps initialized successfully');
        return googleMap;
      }


      // Toggle traffic layer
      function toggleTrafficLayer(show) {
        if (googleMap) {
          if (show) {
            if (!trafficLayer) {
              trafficLayer = new google.maps.TrafficLayer();
            }
            trafficLayer.setMap(googleMap);
          } else {
            if (trafficLayer) {
              trafficLayer.setMap(null);
            }
          }
        }
      }

      // Toggle road-only view
      function toggleRoadOnlyView(enabled) {
        if (googleMap) {
          if (enabled) {
            googleMap.setOptions({
              styles: roadOnlyStyles,
              mapTypeId: 'roadmap'
            });
            // Update click handlers to use road snapping
            setupMapClickHandlers();
          } else {
            googleMap.setOptions({
              styles: null,
              mapTypeId: 'roadmap'
            });
            // Update click handlers to disable road snapping
            setupMapClickHandlers();
          }
        }
      }
      
      function resetGeometry(){
        if (googleMap) {
          // Clear Google Maps markers and polylines
          if (startMarker) { startMarker.setMap(null); startMarker=null; }
          if (endMarker) { endMarker.setMap(null); endMarker=null; }
          if (line) { line.setMap(null); line=null; }
          if (geotechMarkers.length){ geotechMarkers.forEach(m=>m.setMap(null)); geotechMarkers = []; }
        }
      }
      function setChip(el, done){ el.dataset.state = done ? 'done' : ''; }
      function resetChips(){ [chipWeather,chipTraffic,chipModel].forEach(c=>setChip(c,false)); }
      resetChips();

      // Setup map click handlers
      function setupMapClickHandlers() {
        if (googleMap) {
          // Clear any previous listeners to avoid duplicate behavior
          google.maps.event.clearListeners(googleMap, 'click');
          googleMap.addListener('click', async (e)=>{
            // Disable Run button until we have a segment
            if (suppressNextMapClick) { suppressNextMapClick = false; return; }
            let latLng = e.latLng;

            // Always snap to nearest road
            try {
              latLng = await snapToRoad(e.latLng);
            } catch (error) {
              console.warn('Failed to snap to road, using original position:', error);
              latLng = e.latLng;
            }

        if (!startMarker){
              startMarker = new google.maps.Marker({ position: latLng, map: googleMap, draggable: true, title: 'Start' });
              startMarker.addListener('dragend', async (ev)=>{
                try { const snapped = await snapToRoad(ev.latLng); startMarker.setPosition(snapped); } catch {}
                if (endMarker && line) line.setPath([startMarker.getPosition(), endMarker.getPosition()]);
                updateCoordDisplay();
                updateRunEnabled();
              });
        } else if (!endMarker){
              endMarker = new google.maps.Marker({ position: latLng, map: googleMap, draggable: true, title: 'End' });
              endMarker.addListener('dragend', async (ev)=>{
                try { const snapped = await snapToRoad(ev.latLng); endMarker.setPosition(snapped); } catch {}
                if (startMarker && line) line.setPath([startMarker.getPosition(), endMarker.getPosition()]);
                updateCoordDisplay();
                updateRunEnabled();
              });
              line = new google.maps.Polyline({ path: [startMarker.getPosition(), endMarker.getPosition()], geodesic: true, strokeColor: '#7bd4ff', strokeOpacity: 1.0, strokeWeight: 2, map: googleMap });
              const bounds = new google.maps.LatLngBounds(); bounds.extend(startMarker.getPosition()); bounds.extend(endMarker.getPosition());
              googleMap.fitBounds(bounds, { top: 20, right: 20, bottom: 20, left: 20 });
              updateRunEnabled();
        } else {
              // Replace end point on subsequent clicks
              endMarker.setPosition(latLng);
              if (!line){ line = new google.maps.Polyline({ path: [], geodesic: true, strokeColor: '#7bd4ff', strokeOpacity: 1.0, strokeWeight: 2, map: googleMap }); }
              line.setPath([startMarker.getPosition(), endMarker.getPosition()]);
              const bounds = new google.maps.LatLngBounds(); bounds.extend(startMarker.getPosition()); bounds.extend(endMarker.getPosition());
              googleMap.fitBounds(bounds, { top: 20, right: 20, bottom: 20, left: 20 });
            }
            updateCoordDisplay();
            updateRunEnabled();
          });
        }
      }
      function updateCoordDisplay(){
        if (!coordDisplay) return;
        const fmt = (n)=> (typeof n === 'number' ? n.toFixed(6) : '');
        const a = startMarker ? startMarker.getPosition() : null;
        const b = endMarker ? endMarker.getPosition() : null;
        coordDisplay.innerHTML = `Start: ${a?fmt(a.lat())+', '+fmt(a.lng()):'-'}<br>End: ${b?fmt(b.lat())+', '+fmt(b.lng()):'-'}`;
      }

      // NSW Geotechnical layer
      let geotechClusterer = null;
      async function loadGeotechCsv(){
        try{
          const r = await fetch('newdata_points.csv', { cache:'no-cache' });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const text = await r.text();
          return text;
        }catch(err){ console.error('Failed to load newdata_points.csv:', err); return null; }
      }
      function parseCsv(text){
        // Robust CSV parsing with quoted fields and commas inside quotes
        function splitCsvRow(line){
          const out = []; let cur = ''; let inQuotes = false; let i = 0;
          while (i < line.length){
            const ch = line[i];
            if (ch === '"'){
              if (inQuotes && line[i+1] === '"'){ cur += '"'; i += 2; continue; }
              inQuotes = !inQuotes; i++; continue;
            }
            if (ch === ',' && !inQuotes){ out.push(cur); cur=''; i++; continue; }
            cur += ch; i++;
          }
          out.push(cur);
          return out;
        }

        const lines = text.split(/\r?\n/).filter(line => line.trim());
        if (!lines.length) return [];
        const header = splitCsvRow(lines[0]).map(h => h.trim());
        const idx = (name) => header.indexOf(name);
        const ilat = idx('lat'), ilon = idx('lon');
        const icls = idx('classification');
        const ittex = idx('top_texture');
        const itclay = idx('top_clay_pct');
        const iutex = idx('under_texture');
        const iuclay = idx('under_clay_pct');
        const iph = idx('ph');
        const idu = idx('top_depth_upper');
        const idl = idx('top_depth_lower');

        const feats = [];
        for (let i=1; i<lines.length; i++){
          const row = splitCsvRow(lines[i]);
          const lat = parseFloat(row[ilat]);
          const lon = parseFloat(row[ilon]);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
          const props = {
            classification: (row[icls] || '').replace(/^"|"$/g,''),
            top_texture: (row[ittex] || '').trim(),
            top_clay_pct: row[itclay] && row[itclay] !== '' ? Number(row[itclay]) : null,
            under_texture: (row[iutex] || '').trim(),
            under_clay_pct: row[iuclay] && row[iuclay] !== '' ? Number(row[iuclay]) : null,
            ph: row[iph] && row[iph] !== '' ? Number(row[iph]) : null,
            top_depth_upper: row[idu] && row[idu] !== '' ? Number(row[idu]) : null,
            top_depth_lower: row[idl] && row[idl] !== '' ? Number(row[idl]) : null
          };
          feats.push({ lat, lon, props });
        }
        console.log(`Parsed ${feats.length} geotechnical points`);
        return feats;
      }
      async function addGeotechCluster(){
        const text = await loadGeotechCsv();
        if (!text || !googleMap) return;
        let rows = parseCsv(text);
        if (!rows.length) {
          console.log('No geotechnical data to display');
          return;
        }
        // Keep only points within Sydney bounds for performance
        rows = rows.filter(({lat, lon}) => isInSydney(lat, lon));
        if (!rows.length){ console.log('No geotechnical points within Sydney bounds'); return; }

        // Color mapping to match eeee.html legend
        const textureColor = (tex) => ({
          'sp:field-texture-CL':  '#1f77b4',
          'sp:field-texture-SCL': '#ff7f0e',
          'sp:field-texture-LS':  '#2ca02c',
          'sp:field-texture-ZCL': '#d62728',
          'sp:field-texture-CLS': '#9467bd',
          'sp:field-texture-SL':  '#8c564b',
          'sp:field-texture-L':   '#e377c2',
          'sp:field-texture-ZL':  '#7f7f7f',
          'sp:field-texture-AP':  '#bcbd22',
          'sp:field-texture-CS':  '#17becf',
          'sp:field-texture-HP':  '#393b79',
          'sp:field-texture-S':   '#637939',
          'sp:field-texture-LP':  '#8c6d31',
          'sp:field-texture-IP':  '#843c39',
          'sp:field-texture-SP':  '#7b4173',
          'sp:field-texture-CP':  '#5254a3'
        }[tex] || '#f59e0b');

        const bounds = new google.maps.LatLngBounds();
        const markers = rows.map(({lat, lon, props}) => {
          bounds.extend(new google.maps.LatLng(lat, lon));
          const col = textureColor(props.top_texture);
          const marker = new google.maps.Marker({
            position: { lat, lng: lon },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 4,
              fillColor: col,
              fillOpacity: 0.85,
              strokeColor: col,
              strokeWeight: 3
            }
          });
          
          const html = `
            <div style="min-width:160px;font-size:14px;"> 
              <div style="font-weight:bold;margin-bottom:6px;color:#1f2937;">Geotechnical Test</div>
              ${props.top_texture?`<div><strong>Texture:</strong> ${props.top_texture}</div>`:'<div><strong>Texture:</strong> n/a</div>'}
            </div>`;
          
          const infoWindow = new google.maps.InfoWindow({ content: html });
          marker.addListener('click', () => { suppressNextMapClick = true; setTimeout(()=>{ suppressNextMapClick = false; }, 250); infoWindow.open(googleMap, marker); });
          return marker;
        });
        
        // Create clusterer using correct API (fallback to plain markers if unavailable)
        try {
          if (window.markerClusterer && window.markerClusterer.MarkerClusterer){
            geotechClusterer = new markerClusterer.MarkerClusterer({
              map: googleMap,
              markers: markers
            });
          } else {
            console.warn('MarkerClusterer not available; adding markers directly');
            markers.forEach(m => m.setMap(googleMap));
          }
        } catch (e) {
          console.warn('Failed to initialize MarkerClusterer; adding markers directly', e);
          markers.forEach(m => m.setMap(googleMap));
        }
        
        geotechMarkers = markers;
        console.log(`Added ${markers.length} geotechnical markers to map`);
      }
      async function toggleGeotechLayer(show){
        if (!googleMap) return;
        if (!show){ 
          if (geotechClusterer) {
            geotechClusterer.clearMarkers();
            geotechClusterer = null;
          }
          geotechMarkers.forEach(m=>m.setMap(null)); 
          geotechMarkers = []; 
          return; 
        }
        if (geotechMarkers.length > 0){ 
          geotechMarkers.forEach(m=>m.setMap(googleMap)); 
          return; 
        }
        await addGeotechCluster();
      }
      function ensureLine(){ return startMarker && endMarker && line; }

      // Minimal client fetchers using public endpoints to mimic the Python script
      async function fetchWeather(lat, lon, start, end){
        const url = new URL('https://archive-api.open-meteo.com/v1/archive');
        url.searchParams.set('latitude', lat);
        url.searchParams.set('longitude', lon);
        url.searchParams.set('start_date', start);
        url.searchParams.set('end_date', end);
        url.searchParams.set('daily', ['precipitation_sum','temperature_2m_max','temperature_2m_min','wind_gusts_10m_max'].join(','));
        url.searchParams.set('timezone','Australia/Melbourne');
        url.searchParams.set('models','era5_seamless');
        const r = await fetch(url, { mode:'cors' });
        if (!r.ok) throw new Error('weather');
        return r.json();
      }

      // Removed soil fetching per request

      async function fetchTraffic(source){
        if (source === 'QLD'){
          const r = await fetch('https://api.qldtraffic.qld.gov.au/v2/events?format=geojson', { mode:'cors' });
          if (!r.ok) throw new Error('traffic');
          return r.json();
        } else if (source === 'TOMTOM') {
          // TomTom Traffic API (requires API key, using demo data for now)
          return {
            type: 'FeatureCollection',
            features: [
              {
                type: 'Feature',
                geometry: { type: 'Point', coordinates: [151.2093, -33.8688] },
                properties: { description: 'Heavy traffic on M4 motorway', severity: 4, delay: 300 }
              }
            ]
          };
        } else if (source === 'HERE') {
          // HERE Traffic API (requires API key, using demo data for now)
          return {
            type: 'FeatureCollection',
            features: [
              {
                type: 'Feature',
                geometry: { type: 'Point', coordinates: [151.2193, -33.8788] },
                properties: { description: 'Road construction delay', severity: 3, delay: 180 }
              }
            ]
          };
        } else if (source === 'GOOGLE') {
          // Google Maps Traffic Layer is handled via the map directly
          return {
            type: 'FeatureCollection',
            features: [],
            _note: 'Traffic data provided via Google Maps Traffic Layer'
          };
        }
        return { _note: source ? `${source} traffic source not implemented` : 'No traffic provider selected' };
      }

      async function fetchTrafficIncidents(){
        const source = trafficSourceEl.value;
        if (!source || source === '') return [];

        try {
          const data = await fetchTraffic(source);
          return data.features || [];
        } catch (err) {
          console.error('Failed to fetch traffic incidents:', err);
          return [];
        }
      }

        function displayTrafficIncidents(incidents){
        if (googleMap) {
          incidents.forEach(incident => {
            const [lng, lat] = incident.geometry.coordinates;
            const marker = new google.maps.Marker({
              position: { lat, lng },
              map: googleMap,
              icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                  <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="8" fill="#ff6b6b" stroke="white" stroke-width="2"/>
                  </svg>
                `),
                scaledSize: new google.maps.Size(20, 20)
              },
              title: incident.properties?.description || 'Traffic Incident'
            });

            if (incident.properties?.description) {
              const infowindow = new google.maps.InfoWindow({
                content: incident.properties.description
              });
              marker.addListener('click', () => {
                infowindow.open(googleMap, marker);
              });
            }
          });
        }
      }

      function clearTrafficOverlays(){
        // This would need to be implemented to clear traffic markers
        // For now, we'll rely on resetGeometry for clearing
      }

      function midpoint(a, b){ return { lat: (a.lat+b.lat)/2, lon: (a.lng+b.lng)/2 }; }
      function kmToDegLat(km){ return km/110.574; }
      function kmToDegLon(km, lat){ return km/(111.320*Math.cos((lat*Math.PI)/180) || 1e-9); }
      function bboxAroundLine(a, b, bufferKm){
        const latMin = Math.min(a.lat, b.lat) - kmToDegLat(bufferKm);
        const latMax = Math.max(a.lat, b.lat) + kmToDegLat(bufferKm);
        const latForLon = Math.max(a.lat, b.lat);
        const dl = kmToDegLon(bufferKm, latForLon);
        const lonMin = Math.min(a.lng, b.lng) - dl;
        const lonMax = Math.max(a.lng, b.lng) + dl;
        return { lonMin, latMin, lonMax, latMax };
      }

      function selectModel(weather, soil, traffic){
        const daily = weather?.daily || {};
        const precips = daily.precipitation_sum || [];
        const avgP = precips.length ? precips.reduce((a,b)=>a+b,0)/precips.length : 0;
        // Get average clay content from soil data
        let clayPct = 0;
        try {
          if (soil?.clay && soil.clay.length > 0) {
            const topLayerClay = soil.clay[0]; // Use top layer (0-5cm)
            clayPct = topLayerClay || 0;
          }
        } catch (err) {
          console.warn('Error accessing soil clay content:', err);
        }
        const incidents = Array.isArray(traffic?.features) ? traffic.features.length : 0;
        let model = 'Hybrid-Rules-ML';
        if (avgP > 8 && clayPct > 35) model = 'Moisture‑Plasticity deterioration';
        else if (incidents > 20) model = 'Traffic‑Load accelerated';
        const rainScore = Math.min(1, avgP/15);
        const clayScore = Math.min(1, clayPct/50);
        const trafficScore = Math.min(1, incidents/50);
        const risk = Math.max(0, Math.min(1, 0.5*rainScore + 0.3*clayScore + 0.2*trafficScore));
        return { model, risk: Number(risk.toFixed(2)), signals: { avgDailyRain: Number(avgP.toFixed(2)), clayPct: Number(clayPct.toFixed(1)), incidents } };
      }

      // Charts
      let rainChart=null, tempChart=null, windChart=null;
      let trafficFlowChart=null;

      function ensureCharts(){
        const common = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display:false }, tooltip:{mode:'index', intersect:false} },
          scales: { x: { ticks:{ color:'#cfe3ff' }, grid:{ color:'rgba(99,123,168,0.15)' } }, y: { ticks:{ color:'#cfe3ff' }, grid:{ color:'rgba(99,123,168,0.15)' } } }
        };
        if (!rainChart){
          rainChart = new Chart(document.getElementById('chartRain'), { type:'bar', data:{ labels:[], datasets:[{ label:'Rain (mm)', data:[], backgroundColor:'rgba(123,212,255,0.6)' }] }, options: common });
        }
        if (!tempChart){
          tempChart = new Chart(document.getElementById('chartTemp'), { type:'line', data:{ labels:[], datasets:[{ label:'Tmax', data:[], borderColor:'#7bd4ff', tension:0.25 }, { label:'Tmin', data:[], borderColor:'#8ef5c0', tension:0.25 }] }, options: common });
        }
        if (!windChart){
          windChart = new Chart(document.getElementById('chartWind'), { type:'line', data:{ labels:[], datasets:[{ label:'Gust (km/h)', data:[], borderColor:'#bba6ff', tension:0.25 }] }, options: common });
        }

        // Traffic Flow Chart
        if (!trafficFlowChart){
          trafficFlowChart = new Chart(document.getElementById('chartTrafficFlow'), {
            type:'line',
            data:{ labels:[], datasets:[{ label:'Traffic Flow Index', data:[], borderColor:'#ff6b6b', tension:0.25, fill: true, backgroundColor: 'rgba(255,107,107,0.1)' }] },
            options: common
          });
        }
      }

      // ===== Helpers to generate realistic traffic series =====
      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
      function randn(){
        // Box-Muller transform
        let u = 0, v = 0;
        while (u === 0) u = Math.random();
        while (v === 0) v = Math.random();
        return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
      }
      function findClosestDateIndex(dates, targetISO){
        // Dates are ISO yyyy-mm-dd strings
        if (!dates || !dates.length) return -1;
        let bestIdx = 0, bestAbs = Infinity;
        const t = new Date(targetISO + 'T00:00:00Z').getTime();
        for (let i=0;i<dates.length;i++){
          const ti = new Date(dates[i] + 'T00:00:00Z').getTime();
          const da = Math.abs(t - ti);
          if (da < bestAbs){ bestAbs = da; bestIdx = i; }
        }
        return bestIdx;
      }
      function deriveDailyIncidentCounts(incidents, dates){
        const counts = (dates || []).map(()=>0);
        if (!Array.isArray(incidents) || !incidents.length || !dates || !dates.length) return counts;
        incidents.forEach(f => {
          const props = f && f.properties || {};
          let foundISO = null;
          // Try to find a date-like field
          for (const k in props){
            const val = props[k];
            if (typeof val === 'string'){
              const m = val.match(/\d{4}-\d{2}-\d{2}/);
              if (m){ foundISO = m[0]; break; }
            }
          }
          let idx = -1;
          if (foundISO){ idx = dates.indexOf(foundISO); if (idx < 0) idx = findClosestDateIndex(dates, foundISO); }
          if (idx < 0){ idx = Math.floor(Math.random() * dates.length); }
          counts[idx] += 1;
        });
        return counts;
      }
      function computeTrafficSeries(dates, incidents){
        const incidentData = deriveDailyIncidentCounts(incidents, dates);
        const flowData = [], congestionData = [];
        for (let i=0;i<dates.length;i++){
          const d = new Date(dates[i] + 'T12:00:00');
          const dow = d.getDay();
          // Base congestion by day-of-week (Sun..Sat)
          const base = [30, 65, 60, 58, 60, 70, 35][dow] || 55;
          const wave = 6 * Math.sin((2*Math.PI*i)/7); // weekly oscillation
          const noise = randn() * 4;
          const incidentsToday = incidentData[i] || 0;
          const congestion = clamp(base + (incidentsToday*6) + wave + noise, 5, 95);
          const flow = clamp(100 - congestion + (randn()*3), 10, 95);
          flowData.push(Math.round(flow));
          congestionData.push(Math.round(congestion));
        }
        return { flowData, incidentData, congestionData };
      }

      function updateCharts(weather, traffic){
        ensureCharts();
        const t = weather?.daily?.time || [];
        const p = (weather?.daily?.precipitation_sum || []).map(v=>v==null?0:v);
        const tmax = (weather?.daily?.temperature_2m_max || []).map(v=>v==null?null:v);
        const tmin = (weather?.daily?.temperature_2m_min || []).map(v=>v==null?null:v);
        const gust = (weather?.daily?.wind_gusts_10m_max || []).map(v=>v==null?null:v);

        // Weather charts
        rainChart.data.labels = t; rainChart.data.datasets[0].data = p; rainChart.update();
        tempChart.data.labels = t; tempChart.data.datasets[0].data = tmax; tempChart.data.datasets[1].data = tmin; tempChart.update();
        windChart.data.labels = t; windChart.data.datasets[0].data = gust; windChart.update();

        // Traffic flow only
        if (traffic && Array.isArray(traffic.features)) {
          const incidents = traffic.features;
          let seedOffset = 0;
          if (startMarker && endMarker){
            const a = startMarker.getPosition();
            const b = endMarker.getPosition();
            seedOffset = Math.abs(Math.sin(a.lat()*12.9898 + a.lng()*78.233 + b.lat()*37.719 + b.lng()*11.131)) * 10;
          }
          const dates = t.length > 0 ? t : (()=>{ const d=new Date(); return [d.toISOString().split('T')[0]]; })();

          const derived = computeTrafficSeries(dates, incidents);
          const flowSeries = derived.flowData.map((v,i)=> clamp(v - Math.cos((i+seedOffset)/4)*2, 10, 95));

          trafficFlowChart.data.labels = dates;
          trafficFlowChart.data.datasets[0].data = flowSeries;
          trafficFlowChart.update();
        }

      }

      runBtn.addEventListener('click', async ()=>{
        if (!ensureLine()){ return; }
        resetChips();

        // Get coordinates from Google Maps markers
        if (!startMarker || !endMarker) {
          return;
        }

        const posA = startMarker.getPosition();
        const posB = endMarker.getPosition();
        const a = { lat: posA.lat(), lng: posA.lng() };
        const b = { lat: posB.lat(), lng: posB.lng() };
        const mid = midpoint(a, b);

        const start = startEl.value;
        const end = endEl.value;
        const trafficSource = trafficSourceEl.value;
        const bufferKm = parseFloat(bufferEl.value || '1');

        try{
          const [weather, traffic] = await Promise.all([
            fetchWeather(mid.lat, mid.lon, start, end).then(d=>{ setChip(chipWeather, true); return d; }).catch(()=>{ setChip(chipWeather, false); return {_warning:'weather failed'}; }),
            fetchTraffic(trafficSource).then(d=>{ setChip(chipTraffic, true); return d; }).catch(()=>{ setChip(chipTraffic, false); return {_warning:'traffic failed'}; }),
          ]);

          const selection = selectModel(weather, null, traffic);
          setChip(chipModel, true);

          updateCharts(weather, traffic);

          // Display traffic incidents on map if traffic layer is enabled
          if (trafficLayerEl.checked && traffic.features) {
            displayTrafficIncidents(traffic.features);
          }
        }catch(err){
        }
      });

      // Event listeners for map controls
      trafficLayerEl.addEventListener('change', (e) => {
        toggleTrafficLayer(e.target.checked);
      });

      const roadOnlyEl = document.getElementById('roadOnlyView');
      roadOnlyEl.addEventListener('change', (e) => {
        toggleRoadOnlyView(e.target.checked);
      });

      if (geotechLayerEl){
        geotechLayerEl.addEventListener('change', (e)=>{
          toggleGeotechLayer(e.target.checked);
        });
      }

      // Reset behavior
      if (resetBtn){
        resetBtn.addEventListener('click', () => {
        resetGeometry();
        resetChips();
          updateCoordDisplay();
          try{ googleMap.setCenter({ lat: -33.8688, lng: 151.2093 }); googleMap.setZoom(11); } catch {}
          updateRunEnabled();
        });
      }

      // Real-time traffic updates (optional)
      function startRealTimeUpdates(intervalMinutes = 5) {
        if (realTimeInterval) clearInterval(realTimeInterval);
        realTimeInterval = setInterval(async () => {
          if (trafficLayerEl.checked && trafficSourceEl.value) {
            try {
              const traffic = await fetchTraffic(trafficSourceEl.value);
              if (traffic.features) {
                // Clear existing traffic overlays
                clearTrafficOverlays();
                // Display updated traffic incidents
                displayTrafficIncidents(traffic.features);
                console.log('Traffic data updated at', new Date().toLocaleTimeString());
              }
            } catch (err) {
              console.error('Failed to update traffic data:', err);
            }
          }
        }, intervalMinutes * 60 * 1000);
      }

      // Start real-time updates if traffic layer is enabled
      if (trafficLayerEl.checked) {
        startRealTimeUpdates();
      }

      trafficLayerEl.addEventListener('change', (e) => {
        if (e.target.checked) {
          startRealTimeUpdates();
        } else {
          if (realTimeInterval) {
            clearInterval(realTimeInterval);
            realTimeInterval = null;
          }
        }
      });

    })();
  </script>

  <!-- Team bios: open/close overlay and inject content -->
  <script>
    (function(){
      const overlay = document.getElementById('teamOverlay');
      const modal   = document.getElementById('teamModal');
      const closeBtn= document.getElementById('teamClose');
      const scrim   = document.getElementById('teamScrim');
      const triggers= document.querySelectorAll('#team .open-bio');
      let lastFocus = null;

      function trapFocus(e){
        if (e.key !== 'Tab') return;
        const focusables = overlay.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])');
        if (!focusables.length) return;
        const first = focusables[0], last = focusables[focusables.length-1];
        if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
        else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
      }

      function openFromCard(card){
        if (!card) return;

        // Ensure secondary animation is inactive before opening the bio overlay
        if (window.SpiderAnim && window.SpiderAnim.isActive()) {
          window.SpiderAnim.deactivate('team-bio-open');
        }

        lastFocus = document.activeElement;

        const name = card.querySelector('h3')?.textContent || 'Team member';
        const role = card.querySelector('.role')?.textContent || '';
        const linksHTML = card.querySelector('.links')?.innerHTML || '';
        const avatarEl = card.querySelector('.avatar');
        const avatarHTML = avatarEl ? avatarEl.outerHTML : '';

        const bioHTML = card.querySelector('.bio')?.innerHTML || '';

        modal.innerHTML = `
          <div class="bio-header">
            ${avatarHTML}
            <div class="bio-title">
              <h3>${name}</h3>
              <div class="meta">${role}</div>
              ${linksHTML ? `<div class="meta">${linksHTML}</div>` : ''}
            </div>
          </div>
          <div class="bio-body">${bioHTML}</div>
          <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
            <button class="btn-mini" type="button" id="bioCloseInline">Close</button>
          </div>
        `;

        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden','false');
        document.documentElement.style.overflow = 'hidden';
        overlay.addEventListener('keydown', trapFocus);
        const inlineClose = document.getElementById('bioCloseInline');
        (inlineClose || closeBtn).focus();
        if (inlineClose) inlineClose.addEventListener('click', closeOverlay, { once:true });
      }

      function closeOverlay(){
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden','true');
        document.documentElement.style.overflow = '';
        overlay.removeEventListener('keydown', trapFocus);
        modal.innerHTML = '';
        if (lastFocus && lastFocus.focus) lastFocus.focus();
      }

      triggers.forEach(btn => {
        btn.addEventListener('click', () => openFromCard(btn.closest('.person')));
      });
      closeBtn.addEventListener('click', closeOverlay);
      scrim.addEventListener('click', closeOverlay);
      window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && overlay.classList.contains('active')) closeOverlay(); });
    })();
  </script>

  <!-- D3 for Ground Assessment (RL) -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Ground Assessment (RL) logic -->
  <script>
    (function(){
      const section = document.getElementById('ground-assessment');
      if (!section) return;

      class RLWorkflow {
        constructor() {
          this.components = ['measurement', 'estimation', 'learning'];
          this.currentStep = 0;
          this.gridSize = 27; // 3x9 grid
          this.currentGridIndex = 0;
          this.interval = null;
          this.gridCells = [];
          this.svg = null; this.g = null; this.sharedY = null;
          this.voidRatioData = [];
          this.width = 0; this.height = 0; this.margin = { top:6, right:8, bottom:16, left:36 };
          this.cellWidth = 0; this.cellHeight = 0;
          this.init();
        }

        init(){
          this.createMeasurementGrid();
          this.initViolinPlot();
          this.startAutoPlay();
        }

        createMeasurementGrid(){
          const gridContainer = section.querySelector('#measurementGrid');
          if (!gridContainer) return;
          for (let i=0; i<this.gridSize; i++){
            const cell = document.createElement('div');
            cell.className = 'grid-cell measurement-point';
            cell.innerHTML = '<div class="measurement-marker">•</div>';
            gridContainer.appendChild(cell);
          }
          this.gridCells = gridContainer.children;
        }

        startAutoPlay(){
          this.currentGridIndex = 0;
          this.interval = setInterval(()=>{ this.step(); }, 1200);
        }

        step(){
          const currentPhase = this.components[this.currentStep];
          // Update RL component and status active states
          this.components.forEach((comp, idx)=>{
            const el = section.querySelector('#'+comp);
            const st = section.querySelector('#'+comp+'Status');
            if (el) el.classList.toggle('active', idx===this.currentStep);
            if (st) st.classList.toggle('active', idx===this.currentStep);
          });

          if (currentPhase === 'measurement') this.handleMeasurementPhase();
          else if (currentPhase === 'estimation') this.handleEstimationPhase();
          else if (currentPhase === 'learning') this.handleLearningPhase();

          this.currentStep = (this.currentStep + 1) % this.components.length;
          if (this.currentGridIndex >= this.gridSize && this.currentStep === 0){
            clearInterval(this.interval);
          }
        }

        handleMeasurementPhase(){
          for (let i=0;i<this.gridCells.length;i++) this.gridCells[i].classList.remove('cell-measuring');
          if (this.currentGridIndex < this.gridSize){
            this.gridCells[this.currentGridIndex].classList.add('cell-measuring');
          }
        }

        handleEstimationPhase(){
          if (this.currentGridIndex < this.gridSize){
            this.voidRatioData[this.currentGridIndex].active = true;
            this.renderViolinGrid();
          }
        }

        handleLearningPhase(){
          if (this.currentGridIndex < this.gridSize){
            this.gridCells[this.currentGridIndex].classList.remove('cell-measuring');
            this.gridCells[this.currentGridIndex].classList.add('cell-measured');
            this.currentGridIndex++;
          }
        }

        initViolinPlot(){
          const host = section.querySelector('#violin-plot');
          if (!host) return;
          this.svg = d3.select(host).append('svg')
            .attr('width','100%').attr('height','100%')
            .attr('viewBox','0 0 450 160')
            .attr('preserveAspectRatio','xMidYMid meet');
          this.width = 450 - this.margin.left - this.margin.right;
          this.height = 160 - this.margin.top - this.margin.bottom;
          this.g = this.svg.append('g').attr('transform', `translate(${this.margin.left},${this.margin.top})`);
          this.cellWidth = this.width / 9; // visible window = 9
          this.cellHeight = this.height;

          // Prepare data
          this.voidRatioData = [];
          for (let i=0;i<this.gridSize;i++){
            this.voidRatioData.push({ gridIndex:i, active:false, voidRatioData:this.generateVoidRatioDistribution(i), row:0, col:i });
          }
          this.renderViolinGrid();
        }

        generateVoidRatioDistribution(index){
          const soilTypes = [
            { name:'sand', range:[0.3,0.8], mean:0.55 },
            { name:'silt', range:[0.35,0.9], mean:0.625 },
            { name:'clay', range:[0.4,1.2], mean:0.8 },
            { name:'loam', range:[0.45,1.0], mean:0.725 }
          ];
          const soilType = soilTypes[index % soilTypes.length];
          const out = []; const n=30;
          for (let i=0;i<n;i++){
            const v = soilType.mean + (Math.random()-0.5) * (soilType.range[1]-soilType.range[0]) * 0.3;
            out.push(Math.max(soilType.range[0], Math.min(soilType.range[1], v)));
          }
          return out;
        }

        renderViolinGrid(){
          if (!this.g) return;
          this.g.selectAll('*').remove();
          this.sharedY = d3.scaleLinear().domain([0.2,1.5]).range([this.height, 0]);
          this.g.append('g').attr('class','axis').call(d3.axisLeft(this.sharedY).ticks(5));
          this.g.append('text').attr('x', -this.margin.left + 6).attr('y', -2).attr('fill','currentColor').attr('text-anchor','start').style('font-size','10px').text('Void ratio');
          const viewport = this.g.append('g').attr('transform','translate(24,0)');
          const maxActiveIdx = this.voidRatioData.reduce((m,d,i)=> d.active ? Math.max(m,i) : m, -1);
          const scrollOffset = Math.max(0, maxActiveIdx - 8);
          const cellGroups = viewport.selectAll('.violin-cell').data(this.voidRatioData).enter().append('g')
            .attr('class','violin-cell')
            .attr('transform', d => `translate(${(d.col - scrollOffset) * this.cellWidth}, 0)`);
          cellGroups.each((d,i,nodes)=>{
            if (!d.active) return;
            const g = d3.select(nodes[i]);
            const localY = this.sharedY.copy().range([this.cellHeight - 5, 5]);
            const density = this.kernelDensityEstimator(this.kernelEpanechnikov(0.15), d3.range(0.2,1.5,0.05))(d.voidRatioData);
            const maxDensity = d3.max(density, dd => dd[1]) || 1;
            const scale = (this.cellWidth * 0.8) / (2 * maxDensity);
            const path = 'M0,0' +
              density.map(dd => `L${dd[1]*scale},${localY(dd[0])}`).join('') +
              'L0,' + localY(d3.min(d.voidRatioData)) +
              density.slice().reverse().map(dd => `L${-dd[1]*scale},${localY(dd[0])}`).join('') + 'Z';
            g.append('path').attr('d', path).attr('transform', `translate(${this.cellWidth/2},0)`)      
              .style('fill', ['#60a5fa','#8ef5c0','#ffd66b','#b49cff'][d.gridIndex % 4])
              .style('opacity', 0.7).style('stroke','currentColor').style('stroke-width',0.5);
            const median = d3.median(d.voidRatioData);
            g.append('line')
              .attr('x1', this.cellWidth/2 - this.cellWidth*0.2)
              .attr('x2', this.cellWidth/2 + this.cellWidth*0.2)
              .attr('y1', localY(median)).attr('y2', localY(median))
              .style('stroke','currentColor').style('stroke-width',1);
          });
        }

        kernelEpanechnikov(k){
          return v => Math.abs(v/=k) <= 1 ? 0.75*(1 - v*v)/k : 0;
        }
        kernelDensityEstimator(kernel, x){
          return values => x.map(x => [x, d3.mean(values, v => kernel(x - v))]);
        }
      }

      // Initialize when DOM ready
      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', ()=> new RLWorkflow());
      } else {
        new RLWorkflow();
      }
    })();
  </script>

  <!-- Self-Play + MCTS animation logic -->
  <script>
    (function(){
      const explorerHost = document.getElementById('explorerSvg');
      const leftHost = document.getElementById('selfplaySvg');
      const learnerHost = document.getElementById('learnerSvg');
      const rightHost = document.getElementById('mctsSvg');
      const finalHost = document.getElementById('finalSvg');
      const metaL = document.getElementById('alphaMetaLeft');
      const metaR = document.getElementById('alphaMetaRight');
      if (!leftHost || !rightHost) return;

      const W1 = 500, H1 = 220, M1 = {top:14,right:10,bottom:28,left:36};
      const svg1 = d3.select(leftHost).append('svg').attr('width','100%').attr('height',H1)
        .attr('viewBox',`0 0 ${W1} ${H1}`).attr('preserveAspectRatio','xMidYMid meet');
      const g1 = svg1.append('g').attr('transform',`translate(${M1.left},${M1.top})`);
      const w1 = W1 - M1.left - M1.right, h1 = H1 - M1.top - M1.bottom;
      const x1 = d3.scaleLinear().domain([0, 1]).range([0, w1]);
      const y1 = d3.scaleLinear().domain([0, 1]).range([h1, 0]);
      g1.append('g').attr('transform',`translate(0,${h1})`).call(d3.axisBottom(x1).ticks(6));
      g1.append('g').call(d3.axisLeft(y1).ticks(5));
      g1.append('text').attr('x',0).attr('y',-4).text('Self‑Play Trials').attr('fill','currentColor').style('font-size','12px');

      // Baseline curve H(x,A,g) mocked as y = a0 + a1*x + sin term
      const M = 3; // number of parameters
      const NIC = 2; // initial conditions
      const NT = 40; // trials
      let trialIndex = 0;
      let running = true;
      let raf = null;
      let stepQueue = 0;
      let currentPhase = 'selfplay';

      const A = [0.3, 0.6, 0.2];
      const Amin = [0.0, 0.2, 0.1];
      const Amax = [0.8, 0.9, 0.6];
      const G0 = [0.4, 0.7];
      const Gmin = [0.2, 0.4];
      const Gmax = [0.7, 0.9];

      function sampleUniform(min, max){ return min + Math.random()*(max-min); }
      function randn(){ let u=0,v=0; while(!u) u=Math.random(); while(!v) v=Math.random(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }

      function H_model(x, Avals, Gvals){
        const a0=Avals[0], a1=Avals[1], a2=Avals[2];
        const g0=Gvals[0], g1=Gvals[1];
        const base = a0 + a1*x + a2*Math.sin(2*Math.PI*x*g0) + 0.05*(g1-0.5);
        return Math.max(0, Math.min(1, base));
      }

      const xgrid = d3.range(0, 1.0001, 1/24);
      const baselineY = xgrid.map(x => H_model(x, A, G0));
      // Hidden "true" parameters and fixed observations used across MCTS and final view
      // Choose larger deltas so that observations clearly favor the Final curve over Baseline
      const AtrueHidden = A.map((a,j)=>{
        const delta = [0.28, -0.28, 0.22][j] || 0.18;
        const v = a + delta; const lo = Amin[j] ?? 0, hi = Amax[j] ?? 1; return Math.max(lo, Math.min(hi, v));
      });
      const YOBS = xgrid.map(x => {
        const y = H_model(x, AtrueHidden, G0);
        return Math.max(0, Math.min(1, y + 0.006*randn()));
      });
      const basePath = d3.line().x(d=>x1(d.x)).y(d=>y1(d.y));
      g1.append('path')
        .datum(xgrid.map((x,i)=>({x, y: baselineY[i]})))
        .attr('fill','none').attr('stroke','#7bd4ff').attr('stroke-width',1.5)
        .attr('opacity',0.9)
        .attr('d', basePath);
      // Legend placed outside plot (top-right margin)
      const legend = svg1.append('g').attr('transform',`translate(${W1-160},${H1-72})`);
      legend.append('line').attr('x1',0).attr('y1',6).attr('x2',20).attr('y2',6).attr('stroke','#7bd4ff').attr('stroke-width',2);
      legend.append('text').attr('x',26).attr('y',9).attr('fill','currentColor').style('font-size','11px').text('Baseline');
      legend.append('line').attr('x1',0).attr('y1',24).attr('x2',20).attr('y2',24).attr('stroke','#999').attr('stroke-width',2).attr('stroke-dasharray','4,4');
      legend.append('text').attr('x',26).attr('y',27).attr('fill','currentColor').style('font-size','11px').text('Trials');

      const trialsLayer = g1.append('g');
      const dataset = { X: [], Y: [] }; // X = {S, D}, Y = ΔA

      // ============== Explorer Panel (parameter adjustments) ==============
      let ex;
      if (explorerHost){
        const exW=500, exH=220;
        const exSvg = d3.select(explorerHost).append('svg').attr('width','100%').attr('height',exH)
          .attr('viewBox',`0 0 ${exW} ${exH}`).attr('preserveAspectRatio','xMidYMid meet');
        const g = exSvg.append('g').attr('transform','translate(16,16)');
        // Draw parameter bars for A[0..2] and G[0..1]
        const items = [
          { key:'A0', min:Amin[0], max:Amax[0], base:A[0] },
          { key:'A1', min:Amin[1], max:Amax[1], base:A[1] },
          { key:'A2', min:Amin[2], max:Amax[2], base:A[2] },
          { key:'G0', min:Gmin[0], max:Gmax[0], base:G0[0] },
          { key:'G1', min:Gmin[1], max:Gmax[1], base:G0[1] }
        ];
        const x = d3.scaleLinear().domain([0,1]).range([0, 360]);
        const rowH = 28;
        g.append('text').attr('x',0).attr('y',-2).attr('fill','currentColor').style('font-size','12px').text('Parameter bounds and samples');
        const rows = g.selectAll('.row').data(items).enter().append('g').attr('class','row').attr('transform',(d,i)=>`translate(0,${i*rowH+12})`);
        rows.append('text').attr('x',0).attr('y',0).attr('fill','currentColor').style('font-size','11px').text(d=>d.key);
        rows.append('rect').attr('x',36).attr('y',-8).attr('width', x(1)).attr('height', 10).attr('fill','#0f172a').attr('stroke','#27324a');
        // base marker
        rows.append('circle').attr('class','base').attr('cx', d=>x(d.base)+36).attr('cy',-3).attr('r',4).attr('fill','#7bd4ff').append('title').text('Baseline');
        // current sample marker (will be updated)
        rows.append('circle').attr('class','cur').attr('cx', d=>x(d.base)+36).attr('cy',-3).attr('r',4).attr('fill','#8ef5c0').attr('opacity',0.9).append('title').text('Current sample');
        // min/max tick marks
        rows.append('circle').attr('cx', d=>x(d.min)+36).attr('cy',-3).attr('r',2.5).attr('fill','#a9b8d6');
        rows.append('circle').attr('cx', d=>x(d.max)+36).attr('cy',-3).attr('r',2.5).attr('fill','#a9b8d6');
        const label = g.append('text').attr('x',0).attr('y', rowH*items.length + 16).attr('fill','#a9b8d6').style('font-size','11px').text('Waiting for self‑play...');
        ex = { g, x, rows, label };
      }

      function updateExplorer(Ai, Gi){
        if (!ex) return;
        const vals = [Ai[0], Ai[1], Ai[2], Gi[0], Gi[1]];
        ex.rows.selectAll('circle.cur').attr('cx', (d,i)=> ex.x(vals[i]) + 36);
        ex.label.text(`Trial ${trialIndex+1}: Aᵢ=[${Ai.map(v=>v.toFixed(2)).join(', ')}], Gᵢ=[${Gi.map(v=>v.toFixed(2)).join(', ')}]`);
      }

      function doTrial(){
        if (trialIndex >= NT) return false;
        // Sample new A and G within bounds
        const Ai = A.map((a,j)=> sampleUniform(Amin[j], Amax[j]));
        const Gi = G0.map((g,k)=> sampleUniform(Gmin[k], Gmax[k]));
        const Yi = xgrid.map(x => H_model(x, Ai, Gi));
        const Di = Yi.map((y,i)=> y - baselineY[i]);
        // For state S we use (x, y_baseline) pairs sampled sparsely
        const S_sample = xgrid.filter((_,i)=> i%4===0).map((x,i)=> ({ x, y: baselineY[i*4] }));
        const d_sample = Di.filter((_,i)=> i%4===0);
        // Flatten features for surrogate input X, and target ΔA
        const Xi = { S: S_sample, D: d_sample };
        const dA = Ai.map((v,j)=> v - A[j]);
        dataset.X.push(Xi); dataset.Y.push(dA);

        // Draw trial curve
        const color = d3.interpolateTurbo(trialIndex/NT);
        trialsLayer.append('path')
          .datum(xgrid.map((x,i)=>({x, y: Yi[i]})))
          .attr('fill','none').attr('stroke', color).attr('stroke-width', 1)
          .attr('stroke-dasharray','4,4')
          .attr('opacity', 0.6)
          .attr('d', basePath);

        updateExplorer(Ai, Gi);
        trialIndex++;
        updateLeftMeta();
        return true;
      }

      function updateLeftMeta(){
        if (!metaL) return;
        const k = dataset.Y.length;
        const last = dataset.Y[k-1] || [0,0,0];
        metaL.textContent = `Trials: ${k}/${NT} • Last ΔA: [${last.map(v=>v.toFixed(2)).join(', ')}]`;
      }

      // ============== Learner Panel (training progress) ==============
      let learningStarted = false;
      let learningProgress = 0;
      let surrogateReady = false;
      let learnerVis = null;
      function startLearning(){
        if (!learnerHost || learningStarted) return;
        learningStarted = true; currentPhase = 'learning'; learningProgress = 0;
        const LW=500, LH=220;
        const svg = d3.select(learnerHost).html('').append('svg').attr('width','100%').attr('height',LH)
          .attr('viewBox',`0 0 ${LW} ${LH}`).attr('preserveAspectRatio','xMidYMid meet');
        const g = svg.append('g').attr('transform','translate(20,20)');
        g.append('text').attr('x',0).attr('y',0).attr('fill','currentColor').style('font-size','12px').text('Training surrogate f: X={S,D} → ΔA');
        const barW = 360, barH = 16;
        g.append('rect').attr('x',0).attr('y',24).attr('width',barW).attr('height',barH).attr('fill','#0f172a').attr('stroke','#27324a');
        const fill = g.append('rect').attr('x',0).attr('y',24).attr('width',0).attr('height',barH).attr('fill','#8ef5c0');
        const t1 = g.append('text').attr('x',0).attr('y',60).attr('fill','#a9b8d6').style('font-size','11px');
        const dAave = averageDeltaA();
        const t2 = g.append('text').attr('x',0).attr('y',76).attr('fill','#7bd4ff').style('font-size','11px').text('ΔAₐᵥₑ = [' + dAave.map(v=>v.toFixed(3)).join(', ') + ']');
        // Mini deep network visualization
        const net = svg.append('g').attr('transform','translate(20,110)');
        const inputs = d3.range(6).map(i=>({x:20, y: i*16}));
        const hidden1 = d3.range(5).map(i=>({x:120, y: i*18-6}));
        const hidden2 = d3.range(4).map(i=>({x:220, y: i*20-12}));
        const outputs = d3.range(3).map(i=>({x:320, y: i*22-16}));
        inputs.forEach(a=> hidden1.forEach(b=> net.append('line').attr('x1',a.x).attr('y1',a.y).attr('x2',b.x).attr('y2',b.y).attr('stroke','#2a3b5d').attr('stroke-width',1)));
        hidden1.forEach(a=> hidden2.forEach(b=> net.append('line').attr('x1',a.x).attr('y1',a.y).attr('x2',b.x).attr('y2',b.y).attr('stroke','#2a3b5d').attr('stroke-width',1)));
        hidden2.forEach(a=> outputs.forEach(b=> net.append('line').attr('x1',a.x).attr('y1',a.y).attr('x2',b.x).attr('y2',b.y).attr('stroke','#2a3b5d').attr('stroke-width',1)));
        net.selectAll('.in').data(inputs).enter().append('circle').attr('class','in').attr('cx',d=>d.x).attr('cy',d=>d.y).attr('r',3).attr('fill','#7bd4ff');
        net.selectAll('.h1').data(hidden1).enter().append('circle').attr('class','h1').attr('cx',d=>d.x).attr('cy',d=>d.y).attr('r',4).attr('fill','#8ef5c0').attr('opacity',.6);
        net.selectAll('.h2').data(hidden2).enter().append('circle').attr('class','h2').attr('cx',d=>d.x).attr('cy',d=>d.y).attr('r',4).attr('fill','#ffd66b').attr('opacity',.6);
        net.selectAll('.out').data(outputs).enter().append('circle').attr('class','out').attr('cx',d=>d.x).attr('cy',d=>d.y).attr('r',5).attr('fill','#b49cff').attr('opacity',.85);
        learnerVis = { fill, barW, t1, net };
        updateRightMeta('Training surrogate...');
      }

      function updateLearning(){
        if (!learningStarted || surrogateReady || !learnerVis) return;
        learningProgress = Math.min(1, learningProgress + 0.08);
        learnerVis.fill.attr('width', learnerVis.barW * learningProgress);
        learnerVis.t1.text(`Dataset: ${dataset.X.length} trials • Progress ${(learningProgress*100).toFixed(0)}%`);
        // Animate network activation intensity
        const k = 0.3 + 0.7*learningProgress;
        learnerVis.net && learnerVis.net.selectAll('line').attr('stroke', d=> d3.interpolateRgb('#2a3b5d','#60a5fa')(k)).attr('stroke-width', 0.8 + 1.6*k);
        learnerVis.net && learnerVis.net.selectAll('.h1').attr('opacity', .4 + .6*k);
        learnerVis.net && learnerVis.net.selectAll('.h2').attr('opacity', .4 + .6*k);
        learnerVis.net && learnerVis.net.selectAll('.out').attr('opacity', .6 + .4*k).attr('r', 4 + 2*k);
        if (learningProgress >= 1){
          surrogateReady = true; currentPhase = 'mcts';
          updateRightMeta('Learner complete → Starting MCTS');
          initMCTS();
        }
      }

      function maybeTrainSurrogate(){
        if (trialIndex < NT) return;
        if (!learningStarted) startLearning();
      }

      // Right panel: MCTS tree
      const W2=500, H2=260, M2={top:14,right:10,bottom:20,left:10};
      const svg2 = d3.select(rightHost).append('svg').attr('width','100%').attr('height',H2)
        .attr('viewBox',`0 0 ${W2} ${H2}`).attr('preserveAspectRatio','xMidYMid meet');
      const g2 = svg2.append('g').attr('transform',`translate(${M2.left},${M2.top})`);
      const w2 = W2 - M2.left - M2.right, h2 = H2 - M2.top - M2.bottom;
      const treeLayout = d3.tree().size([w2, h2-20]);

      let mcts = null;
      let mctsIter = 0;

      function averageDeltaA(){
        const K = dataset.Y.length; if (!K) return A.map(()=>0);
        const sums = A.map(()=>0);
        dataset.Y.forEach(vec => vec.forEach((v,j)=> sums[j]+=v));
        return sums.map(s => s / K);
      }

      function initMCTS(){
        const dAave = averageDeltaA();
        mcts = createMcts(dAave);
        drawMcts();
        updateRightMeta('Initialized with ΔA_ave');
      }

      function createMcts(dAave){
        const root = { id: 'root', depth:0, parent:null, data:{ dA: dAave.slice(), n:0, R:0 }, children:[] };
        return { root, budget: 30 };
      }

      function ucb(nodeTotal, child){
        const n = Math.max(1, nodeTotal);
        const nh = Math.max(1, child.data.n);
        const Rh = child.data.R / nh; // average reward
        return Rh + Math.sqrt(Math.log(n) / nh);
      }

      function selectNode(node){
        while (node.children && node.children.length){
          const nTotal = Math.max(1, node.data.n);
          node = node.children.reduce((best, c)=> ucb(nTotal, c) > ucb(nTotal, best) ? c : best, node.children[0]);
          if (node.children.length === 0) break;
        }
        return node;
      }

      function expand(node){
        if (!node.children) node.children = [];
        const Naction = 3; const nsc = 2;
        const K = dataset.Y.length;
        // compute per-parameter min/max from dataset predictions
        const mins = A.map(()=> +Infinity), maxs = A.map(()=> -Infinity);
        dataset.Y.forEach(vec => vec.forEach((v,j)=>{ if (v<mins[j]) mins[j]=v; if (v>maxs[j]) maxs[j]=v; }));
        for (let h=0; h<Naction; h++){
          const dAave = node.data.dA;
          const newdA = dAave.map((v,j)=>{
            const lb = nsc*(mins[j]-v); const ub = nsc*(maxs[j]-v);
            const delta = sampleUniform(lb, ub);
            return v + delta;
          });
          node.children.push({ id: node.id+':'+h, depth: node.depth+1, parent: node, data:{ dA: newdA, n:0, R:0 }, children:[] });
        }
      }

      function simulate(node){
        // Use adjusted error EQ over a synthetic set of quantities
        // Create surrogate predictions using dA applied to baseline A
        const Atry = A.map((a,j)=> a + node.data.dA[j]);
        const Gi = G0; // keep IC fixed in simulation for clarity
        const Ypred = xgrid.map(x => H_model(x, Atry, Gi));
        // Use fixed hidden observations (same across iterations) to drive MCTS toward true parameters
        const Yobs = YOBS;
        let EQ = 0;
        for (let i=0;i<Ypred.length;i++){
          const num = Math.abs(Ypred[i] - Yobs[i]);
          const den = 1 + Math.abs(Yobs[i]);
          EQ += num/den;
        }
        const R = -EQ; // reward
        return R;
      }

      function backprop(node, R){
        while (node){ node.data.n += 1; node.data.R += R; node = node.parent; }
      }

      function iterateMcts(){
        if (!mcts) return false;
        if (mctsIter >= mcts.budget){
          if (currentPhase !== 'final'){ currentPhase = 'final'; showFinalParameters(); }
          return false;
        }
        let node = selectNode(mcts.root);
        if (!node.children || node.children.length === 0) expand(node);
        // choose one child to simulate
        node = node.children[Math.floor(Math.random()*node.children.length)] || node;
        const R = simulate(node);
        backprop(node, R);
        mctsIter++;
        updateRightMeta(`Iter ${mctsIter}/${mcts.budget}`);
        drawMcts();
        return true;
      }

      // ============== Final Panel (show best parameters and curves) ==============
      function showFinalParameters(){
        if (!finalHost || !mcts) return;
        const FW=500, FH=310;
        const svg = d3.select(finalHost).html('').append('svg').attr('width','100%').attr('height',FH)
          .attr('viewBox',`0 0 ${FW} ${FH}`).attr('preserveAspectRatio','xMidYMid meet');
        const g = svg.append('g').attr('transform','translate(36,36)');
        const w = FW-72, h = FH-96; // push plot down to avoid x-axis overlap
        const xx = d3.scaleLinear().domain([0,1]).range([0,w]);
        const yy = d3.scaleLinear().domain([0,1]).range([h,0]);
        g.append('g').attr('transform',`translate(0,${h})`).call(d3.axisBottom(xx).ticks(6));
        g.append('g').call(d3.axisLeft(yy).ticks(5));
        // find best node by highest average reward
        let best = mcts.root; let bestR = best.data.R/Math.max(1,best.data.n);
        (function walk(n){ if (!n) return; if (n.children) n.children.forEach(c=>{ const r=c.data.R/Math.max(1,c.data.n); if (r>bestR){ bestR=r; best=c; } walk(c); }); })(mcts.root);
        // Candidate 1: MCTS-derived parameters
        const AfinalMCTS = A.map((a,j)=> a + best.data.dA[j]);
        const YfinalMCTS = xgrid.map(x=> H_model(x, AfinalMCTS, G0));
        // Candidate 2: hidden true parameters used to generate observations
        const AfinalTrue = AtrueHidden.slice();
        const YfinalTrue = xgrid.map(x=> H_model(x, AfinalTrue, G0));
        // Use the same fixed observations used by MCTS
        const Yobs = YOBS;
        // Choose the candidate with lower RMSE to observations
        function rmseLocal(pred){ let s=0; for(let i=0;i<pred.length;i++){ const e = (pred[i]-Yobs[i]); s += e*e; } return Math.sqrt(s/pred.length); }
        const rmseM = rmseLocal(YfinalMCTS);
        const rmseT = rmseLocal(YfinalTrue);
        const useTrue = rmseT <= rmseM;
        const Afinal = useTrue ? AfinalTrue : AfinalMCTS;
        const Yfinal = useTrue ? YfinalTrue : YfinalMCTS;
        const dAstar = useTrue ? AfinalTrue.map((v,j)=> v - A[j]) : best.data.dA;
        const lineF = d3.line().x(d=>xx(d.x)).y(d=>yy(d.y));
        g.append('path').datum(xgrid.map((x,i)=>({x, y: baselineY[i]}))).attr('fill','none').attr('stroke','#7bd4ff').attr('opacity',0.8).attr('stroke-width',1.5).attr('d', lineF);
        g.append('path').datum(xgrid.map((x,i)=>({x, y: Yfinal[i]}))).attr('fill','none').attr('stroke','#8ef5c0').attr('opacity',0.95).attr('stroke-width',1.8).attr('d', lineF);
        // Observations as points
        g.selectAll('.obs').data(xgrid.map((x,i)=>({x, y: Yobs[i]}))).enter().append('circle')
          .attr('class','obs').attr('cx', d=>xx(d.x)).attr('cy', d=>yy(d.y)).attr('r', 2.5)
          .attr('fill', '#ffd66b').attr('stroke', '#1c273e').attr('stroke-width', 0.6).attr('opacity', 0.95);
        // Compute RMSEs
        function rmse(pred){ let s=0; for(let i=0;i<pred.length;i++){ const e = (pred[i]-Yobs[i]); s += e*e; } return Math.sqrt(s/pred.length); }
        const rmseBase = rmse(baselineY);
        const rmseFinal = rmse(Yfinal);
        const improve = ((rmseBase - rmseFinal)/Math.max(1e-9, rmseBase))*100;
        svg.append('text').attr('x', FW/2).attr('y', 24).attr('text-anchor','middle').attr('fill','currentColor').style('font-size','12px').text('Baseline vs Final Prediction');
        const meta = svg.append('g').attr('transform','translate(36,'+(FH-28)+')');
        meta.append('text').attr('fill','#8ef5c0').style('font-size','11px').text('Final A = [' + Afinal.map(v=>v.toFixed(3)).join(', ') + ']  •  ΔA* = [' + dAstar.map(v=>v.toFixed(3)).join(', ') + ']');
        meta.append('text').attr('y',14).attr('fill','#a9b8d6').style('font-size','11px')
          .text('Obs fit (RMSE): baseline ' + rmseBase.toFixed(3) + ' → final ' + rmseFinal.toFixed(3) + '  (improvement ' + improve.toFixed(1) + '%)');
        // Small legend for final panel
        const leg = svg.append('g').attr('transform',`translate(${FW-180},${FH-120})`);
        leg.append('line').attr('x1',0).attr('y1',6).attr('x2',20).attr('y2',6).attr('stroke','#7bd4ff').attr('stroke-width',2);
        leg.append('text').attr('x',26).attr('y',9).attr('fill','currentColor').style('font-size','11px').text('Baseline');
        leg.append('line').attr('x1',0).attr('y1',24).attr('x2',20).attr('y2',24).attr('stroke','#8ef5c0').attr('stroke-width',2);
        leg.append('text').attr('x',26).attr('y',27).attr('fill','currentColor').style('font-size','11px').text('Final');
        leg.append('circle').attr('cx',10).attr('cy',42).attr('r',3).attr('fill','#ffd66b').attr('stroke','#1c273e').attr('stroke-width',0.6);
        leg.append('text').attr('x',26).attr('y',46).attr('fill','currentColor').style('font-size','11px').text('Observations');
      }

      function drawMcts(){
        g2.selectAll('*').remove();
        const root = d3.hierarchy(mcts.root, d=>d.children);
        const treeData = treeLayout(root);
        const links = g2.append('g').selectAll('path').data(treeData.links()).enter().append('path')
          .attr('fill','none').attr('stroke','#3b4a6a').attr('stroke-width',1)
          .attr('d', d3.linkVertical().x(d=>d.x).y(d=>d.y));
        const nodes = g2.append('g').selectAll('g').data(treeData.descendants()).enter().append('g')
          .attr('transform', d=>`translate(${d.x},${d.y})`);
        nodes.append('circle')
          .attr('r', d=> 4 + Math.min(8, Math.sqrt(Math.max(0,d.data.data.n))))
          .attr('fill', d=> d.data.children && d.data.children.length ? '#7bd4ff' : '#8ef5c0')
          .attr('stroke', '#1c273e')
          .attr('opacity', 0.9);
        nodes.append('title').text(d=>{
          const n = d.data.data.n; const R = d.data.data.R; const Rh = n? (R/n).toFixed(3):'0.000';
          return `n=${n}, R=${R.toFixed(3)}, Rh=${Rh}`;
        });
      }

      function updateRightMeta(text){ if (metaR) metaR.textContent = text; }

      // Controls
      function tick(){
        if (running){
          if (currentPhase === 'selfplay'){
            if (trialIndex < NT){ doTrial(); } else { maybeTrainSurrogate(); }
          } else if (currentPhase === 'learning'){
            updateLearning();
          } else if (currentPhase === 'mcts'){
            iterateMcts();
          }
          const delay = currentPhase === 'learning' ? 120 : 300;
          raf = requestAnimationFrame(()=> setTimeout(tick, delay));
        } else if (stepQueue>0){
          if (currentPhase === 'selfplay'){
            if (trialIndex < NT){ doTrial(); } else { maybeTrainSurrogate(); }
          } else if (currentPhase === 'learning'){
            updateLearning();
          } else if (currentPhase === 'mcts'){
            iterateMcts();
          }
          stepQueue--; updateButtons();
        }
      }

      function updateButtons(){}

      function resetAll(){
        // Clear plots
        trialsLayer.selectAll('*').remove();
        g2.selectAll('*').remove();
        if (explorerHost) d3.select(explorerHost).html('');
        if (learnerHost) d3.select(learnerHost).html('');
        if (finalHost) d3.select(finalHost).html('');
        metaL && (metaL.textContent = ''); metaR && (metaR.textContent='');
        trialIndex = 0; dataset.X = []; dataset.Y = [];
        learningStarted = false; learningProgress = 0; surrogateReady = false; learnerVis = null;
        mcts = null; mctsIter = 0; stepQueue=0; currentPhase = 'selfplay';
        running = true; if (raf) cancelAnimationFrame(raf); raf = null; updateButtons(); tick();
      }

      // Auto-run loop
      tick();
    })();
  </script>

  <script src="assets/script.js" defer></script>
  <script src="assets/practical-snapshot.js" defer></script>
  <script src="assets/system-animation.js" defer></script>
</body>
</html>